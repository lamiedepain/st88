<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning - ST88</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fb;
            min-height: 100vh;
            padding: 0;
            color: #2c3e50;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: #ffffff;
            padding: 20px 32px;
            border-bottom: 1px solid #e8ebf0;
            margin-bottom: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        h1 {
            color: #1a202c;
            margin-bottom: 12px;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        nav {
            display: flex;
            gap: 2px;
            margin-bottom: 0;
        }

        nav a {
            padding: 6px 12px;
            background: transparent;
            color: #718096;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }

        nav a:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        nav a.active {
            background: #edf2f7;
            color: #2d3748;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 16px;
            background: #edf2f7;
            padding: 3px;
            border-radius: 6px;
            display: inline-flex;
        }

        .view-tab {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #718096;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: #2d3748;
        }

        .view-tab.active {
            background: #ffffff;
            color: #2d3748;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            font-weight: 600;
        }

        select {
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            color: #2d3748;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: #a0aec0;
        }

        select:focus {
            outline: none;
            border-color: #4a5568;
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.1);
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-print {
            background: #2d3748;
            color: white;
        }

        .btn-print:hover {
            background: #1a202c;
        }

        .planning-container {
            background: white;
            padding: 16px;
            overflow-x: auto;
            margin: 0;
            border: 1px solid #e8ebf0;
            border-radius: 6px;
            margin: 16px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            box-shadow: none;
        }

        th,
        td {
            padding: 8px 10px;
            border-bottom: 1px solid #edf2f7;
            text-align: center;
            font-size: 12px;
            min-width: 44px;
            vertical-align: middle;
        }

        .cell-inner {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 3px;
            overflow: visible;
            white-space: normal;
            flex-wrap: wrap;
            gap: 3px;
        }

        .agent-cell {
            overflow: visible !important;
        }

        .agent-badges {
            position: relative;
            z-index: 30;
        }

        th {
            background: #2d3748;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid #1a202c;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.02em;
            padding: 8px 10px;
        }

        .agent-cell {
            font-weight: 600;
            text-align: left;
            background: #ffffff;
            position: sticky;
            left: 0;
            z-index: 15;
            min-width: 200px;
            max-width: 280px;
            padding: 10px 12px;
            border-right: 1px solid #edf2f7;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.02);
        }

        .agent-name {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: 700;
            color: #1a202c;
        }

        .agent-badges {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        .badge-mini {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            font-size: 7px;
            font-weight: bold;
            color: white;
            line-height: 14px;
            text-align: center;
        }

        .cell-inner .badge-mini {
            width: 10px;
            height: 10px;
            line-height: 10px;
            font-size: 6px;
        }

        .cell-inner .agent-badges {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .badge-caces {
            background: #faad14;
        }

        .badge-permis {
            background: #f5a4a4;
        }

        .badge-aipr {
            background: #a8d8ff;
        }

        .badge-fimo {
            background: #dda0dd;
        }

        .badge-tronco {
            background: #cbd5e0;
        }

        .badge-secours {
            background: #ffb3a3;
        }

        .day-cell {
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
            min-height: 36px;
            padding: 6px 4px;
            white-space: normal;
            overflow: visible;
        }

        .day-cell:hover {
            background: #e6f2ff;
        }

        .day-cell.weekend {
            background: #fae8e8;
        }

        .day-cell.present {
            background: #e6f7ee;
        }

        .day-cell.absent {
            background: #fde8e8;
        }

        .day-cell.conge {
            background: #fffbe6;
        }

        tr:nth-child(even) .agent-cell {
            background: #f8f9fb;
        }

        .loading {
            text-align: center;
            padding: 32px;
            font-size: 14px;
            color: #718096;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #1a202c;
            font-size: 18px;
        }

        .modal-content label {
            display: block;
            margin: 12px 0 4px;
            font-weight: 600;
            color: #1a202c;
            font-size: 13px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            outline: none;
            border-color: #4a5568;
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-cancel {
            background: #cbd5e0;
            color: #1a202c;
        }

        .btn-generate {
            background: #4a90e2;
            color: white;
        }

        .btn-generate:hover {
            background: #357abd;
        }

        @media print {

            /* Page size for print: A3 by default, switch via body classes */
            @page {
                size: A3 portrait;
                margin: 10mm;
            }

            body.landscape-print {
                @page {
                    size: A3 landscape;
                    margin: 10mm;
                }
            }

            body.quarterly-print {
                @page {
                    size: A3 portrait;
                    margin: 10mm;
                }
            }

            body.annual-print {
                @page {
                    size: A3 portrait;
                    margin: 10mm;
                }
            }

            /* Preserve colors in print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Layout cleanup for print */
            body {
                background: white !important;
                padding: 0;
                margin: 0;
                color: #0f172a;
            }

            header nav,
            .controls,
            .view-tabs,
            header>div:first-child,
            #progressContainer,
            .modal {
                display: none !important;
            }

            .container,
            .planning-container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0;
            }

            #planningTable {
                width: 100% !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Ensure each month block doesn't split awkwardly */
            .month-container {
                page-break-inside: avoid;
                margin-bottom: 8mm;
            }

            body.annual-print .month-container:nth-of-type(3n+1):not(:first-of-type) {
                page-break-before: always;
            }

            /* Table print styling: larger than previous to be readable on A3 */
            table {
                font-size: 9px !important;
                width: 100% !important;
                table-layout: fixed !important;
                border-collapse: collapse !important;
                page-break-inside: auto;
            }

            thead {
                display: table-header-group;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            th,
            td {
                padding: 6px 8px !important;
                border: 0.5pt solid #cddff6 !important;
                line-height: 1.15 !important;
                font-size: 9px !important;
            }

            th {
                background: #0f172a !important;
                color: #fff !important;
                font-weight: 700 !important;
                padding: 8px 10px !important;
                position: static !important;
            }

            /* Print: ensure badges and cell content remain visible and compact */
            .cell-inner {
                aspect-ratio: auto !important;
                padding: 2px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                height: auto !important;
            }

            .cell-inner .badge-mini {
                width: 8px !important;
                height: 8px !important;
                line-height: 8px !important;
                font-size: 6px !important;
            }

            /* Agent column should remain visible but compact */
            .agent-cell {
                font-size: 9px !important;
                min-width: 90px !important;
                max-width: 220px !important;
                width: 140px !important;
                padding: 6px 8px !important;
                position: static !important;
                box-shadow: none !important;
                border-right: 0.5pt solid #cddff6 !important;
            }

            .agent-name {
                font-size: 9px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin: 0 !important;
            }

            .badge-mini {
                width: 10px !important;
                height: 10px !important;
                font-size: 6px !important;
                line-height: 10px !important;
            }

            .day-cell {
                text-align: center !important;
                font-size: 9px !important;
                padding: 4px !important;
            }

            /* In print, don't force square aspect too aggressively; let rows adapt */
            .cell-inner {
                aspect-ratio: auto !important;
                padding: 2px !important;
                display: block !important;
                height: auto !important;
            }

            /* Hide elements that shouldn't appear in print */
            .view-tab,
            button,
            input,
            select,
            .controls,
            nav,
            .modal {
                display: none !important;
            }

            br {
                display: none;
            }

            /* Corrections suppl√©mentaires pour l'impression */
            table {
                table-layout: auto !important;
                width: 100% !important;
                font-size: 9px !important;
            }

            td,
            th {
                height: auto !important;
                min-height: 0 !important;
                overflow: visible !important;
                white-space: normal !important;
                word-break: break-word !important;
            }

            td.day-cell {
                padding: 4px !important;
                height: auto !important;
            }

            /* Disable any fixed heights set by JS for print */
            td[style*="height:"] {
                height: auto !important;
                max-height: none !important;
            }

            /* Make agent column compact and static in print */
            .agent-cell {
                position: static !important;
                box-shadow: none !important;
                width: 140px !important;
                min-width: 90px !important;
                max-width: 220px !important;
                overflow: visible !important;
            }

            /* Ensure badges print and remain legible */
            .badge-mini,
            .cell-inner .badge-mini {
                display: inline-block !important;
                width: 8px !important;
                height: 8px !important;
                line-height: 8px !important;
                font-size: 6px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìÖ Planning</h1>

            <nav>
                <a href="/">Agents</a>
                <a href="/planning" class="active">Planning</a>
                <a href="/generator">G√©n√©rateur</a>
                <a href="/api/download-excel" style="background: #e67e22;">üì• T√©l√©charger Excel</a>
            </nav>

            <div class="view-tabs">
                <button class="view-tab" onclick="changeView('annuel')">üìÜ Annuel</button>
                <button class="view-tab" onclick="changeView('trimestriel')">üìä Trimestriel</button>
                <button class="view-tab active" onclick="changeView('mensuel')">üìÖ Mensuel</button>
                <button class="view-tab" onclick="changeView('bihebdo')">üìã Bi-hebdo</button>
            </div>

            <div class="controls">
                <div
                    style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Groupes :</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox" value="all" checked
                            onchange="toggleAllGroups(this)"> Tous</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox" value="Encadrant"
                            checked onchange="filterByGroup()"> Encadrant</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox"
                            value="Surveillant de travaux" checked onchange="filterByGroup()"> Surveillant de
                        travaux</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox"
                            value="Encadrant Propret√©" checked onchange="filterByGroup()"> Encadrant Propret√©</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox" value="Agents Voirie"
                            checked onchange="filterByGroup()"> Agents Voirie</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox" value="Agent EV"
                            checked onchange="filterByGroup()"> Agent EV</label>
                    <label style="cursor: pointer;"><input type="checkbox" class="groupCheckbox"
                            value="COMMUN - Magasinier" checked onchange="filterByGroup()"> COMMUN - Magasinier</label>
                </div>

                <select id="periodSelector">
                    <option value="">S√©lectionner une p√©riode...</option>
                </select>

                <input type="file" id="excelUpload" accept=".xlsx,.xlsm" style="display: none;"
                    onchange="loadExcelPlanning(event)">
                <button class="btn-print" onclick="document.getElementById('excelUpload').click()"
                    style="background: #3498db;">üìÇ Charger Excel</button>

                <button class="btn-print" onclick="refreshPlanning()" style="background: #27ae60;">üîÑ
                    Actualiser</button>

                <select id="printOrientation" style="min-width: 150px;">
                    <option value="portrait">A3 Portrait</option>
                    <option value="landscape">A3 Paysage</option>
                </select>

                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer</button>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; align-items: center;">
                <div style="font-weight: 600; color: #2c3e50;">L√©gende :</div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #00ff00; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Pr√©sence ‚Äî code: P">Pr√©sence (P)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff00ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Pr√©v. Cong√©s ‚Äî code: PC">Pr√©v Cong√©s (PC)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #8000ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Formation ‚Äî code: F">Formation (F)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #0000ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Astreinte ‚Äî code: AST">Astreinte (AST)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff00; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Cong√©s Annuel ‚Äî code: CA">Cong√©s Annuel (CA)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff80; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="RTT ‚Äî R√©duction du temps de travail">RTT</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #00ffff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Cong√©s exceptionnels ‚Äî code: CEX">Cong√©s Exc (CEX)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff0000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="R√©serve ‚Äî code: R">R√©serve (R)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff8000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Maladie ‚Äî code: M">Maladie (M)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff4000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Accident du travail ‚Äî code: AT">Accident Travail (AT)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #0080ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Travail √† distance ‚Äî code: TAD">Travail Distance (TAD)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff80; border-radius: 4px;"></div>
                    <span style="font-size: 14px;" title="Temps partiel ‚Äî code: TP">Temps Partiel (TP)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #e74c3c; opacity: 0.3; border-radius: 4px;">
                    </div>
                    <span style="font-size: 14px;">Week-end</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff9800; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Jour f√©ri√©</span>
                </div>
            </div>
        </header>

        <!-- Barre de progression -->
        <div id="progressContainer"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 32px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); z-index: 10000; min-width: 420px; border: 1px solid #e5e7eb;">
            <div style="text-align: center; margin-bottom: 20px; font-size: 16px; font-weight: 600; color: #111827;">
                Chargement en cours
            </div>
            <div
                style="width: 100%; height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden; position: relative;">
                <div id="progressFill"
                    style="height: 100%; width: 0%; background: #111827; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
                </div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 12px; font-size: 13px; color: #6b7280;">
                0%
            </div>
        </div>

        <!-- Modal de g√©n√©ration -->
        <div id="generateModal" class="modal">
            <div class="modal-content">
                <h2>‚ö° G√©n√©rer un Planning</h2>
                <label for="generateWeek">Semaine :</label>
                <input type="week" id="generateWeek" required>

                <label for="teamSize">Agents par √©quipe :</label>
                <select id="teamSize">
                    <option value="2">2 agents</option>
                    <option value="3" selected>3 agents</option>
                </select>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeGenerateModal()">Annuler</button>
                    <button class="btn-generate" onclick="generatePlanningFromModal()">G√©n√©rer</button>
                </div>
            </div>
        </div>

        <div class="planning-container">
            <div id="planningTable" class="loading">
                S√©lectionnez une p√©riode pour afficher le planning
            </div>
        </div>
    </div>

    <script>
        let currentView = 'mensuel';
        let allAgents = [];
        let selectedGroup = 'all';
        let currentPlanningData = null;

        const periodSelector = document.getElementById('periodSelector');
        const planningTable = document.getElementById('planningTable');

        const groupes = {
            'Encadrant': ['DEBREYNE', 'LUTARD', 'HAUTDECOEUR', 'GRENET', 'FOURCADE', 'GONCALVES', 'SIGALA', 'BETTINGER', 'TUCOULET', 'VRBOVSKA'],
            'Surveillant de travaux': ['BOURGOIN', 'MERCADIEU', 'GARCIA', 'LARROUDE', 'SAMITIER', 'PIEL'],
            'Encadrant Propret√©': ['GOURVIAT', 'LARTIGUE', 'TRIQUENEAUX', 'ESPERON', 'ROUGLAN', 'NOURRI'],
            'Agents Voirie': ['BERRIO-GAUDNER', 'FONTENEAU', 'GUIJARRO', 'GOUREAU', 'LABORIE', 'LARRIEU', 'LEVIGNAT', 'MARTIN-HERNANDEZ', 'PIERRE', 'SOLA', 'WEISS'],
            'Agent EV': ['DELANDE', 'DA SILVA REIS', 'ELMAGROUD', 'ESTEVE', 'KADRI', 'MALLET', 'MAURY', 'MOINGT', 'REY', 'TADJROUNA', 'VILLENEUVE'],
            'COMMUN - Magasinier': ['VOL', 'GENNA', 'BERNARD', 'HAUBRAICHE']
        };

        const groupColors = {
            'Encadrant': { bg: '#f093fb', border: '#f5576c' },
            'Surveillant de travaux': { bg: '#a8edea', border: '#a8edea' },
            'Encadrant Propret√©': { bg: '#72EDF2', border: '#5151E5' },
            'Agents Voirie': { bg: '#4facfe', border: '#00f2fe' },
            'Agent EV': { bg: '#43e97b', border: '#38f9d7' },
            'COMMUN - Magasinier': { bg: '#fa709a', border: '#fee140' },
            'default': { bg: '#667eea', border: '#764ba2' }
        };

        // Jours f√©ri√©s 2026 en France
        const joursFeries2026 = [
            '2026-01-01', // Jour de l'an
            '2026-04-06', // Lundi de P√¢ques
            '2026-05-01', // F√™te du travail
            '2026-05-08', // Victoire 1945
            '2026-05-14', // Ascension
            '2026-05-25', // Lundi de Pentec√¥te
            '2026-07-14', // F√™te nationale
            '2026-08-15', // Assomption
            '2026-11-01', // Toussaint
            '2026-11-11', // Armistice 1918
            '2026-12-25'  // No√´l
        ];

        function isJourFerie(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return joursFeries2026.includes(dateStr);
        }

        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    allAgents = data.agents.map((agent, index) => {
                        const aptitudes = [];
                        agent.data.forEach((val, idx) => {
                            const header = data.headers[idx];
                            if (header && idx >= 7) {
                                // Accepter toute valeur non vide comme aptitude : date, 'x', texte libre (ex: 'Dec-28')
                                if (val !== null && val !== undefined && String(val).toString().trim() !== '') {
                                    let dateObj = null;
                                    let display = '';

                                    // Essayer de parser en date
                                    const parsed = new Date(val);
                                    if (!isNaN(parsed.getTime())) {
                                        dateObj = parsed;
                                        try {
                                            display = parsed.toLocaleDateString('fr-FR');
                                        } catch (e) {
                                            display = String(val);
                                        }
                                    } else if (typeof val === 'string' && val.trim().toLowerCase() === 'x') {
                                        display = '‚úì';
                                    } else {
                                        display = String(val).trim();
                                    }

                                    aptitudes.push({
                                        nom: header,
                                        valeur: display,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        });

                        const nom = agent.nom.toUpperCase().trim(); // TRIM
                        let groupe = 'default';

                        for (const [groupeName, noms] of Object.entries(groupes)) {
                            if (noms.some(n => nom === n)) {
                                groupe = groupeName;
                                break;
                            }
                        }

                        return {
                            index,
                            matricule: agent.matricule,
                            nom: agent.nom,
                            prenom: agent.prenom,
                            fullName: `${agent.nom} ${agent.prenom}`,
                            aptitudes,
                            groupe
                        };
                    });
                }
            } catch (error) {
                console.error('Erreur chargement agents:', error);
            }
        }

        function showProgress(percent, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = message + ' - ' + percent + '%';
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            setTimeout(() => {
                progressContainer.style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
            }, 500);
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Appliquer la classe d'impression appropri√©e
            document.body.classList.remove('landscape-print', 'portrait-print', 'quarterly-print', 'annual-print');
            if (view === 'annuel') {
                document.body.classList.add('annual-print');
            } else if (view === 'trimestriel') {
                document.body.classList.add('quarterly-print');
            } else if (view === 'mensuel') {
                document.body.classList.add('portrait-print');
            } else if (view === 'bihebdo') {
                document.body.classList.add('landscape-print');
            }

            updatePeriodSelector();
            planningTable.innerHTML = '<div class="loading">S√©lectionnez une p√©riode</div>';
        }

        function updatePeriodSelector() {
            periodSelector.innerHTML = '<option value="">S√©lectionner une p√©riode...</option>';

            const currentYear = 2026;
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            if (currentView === 'annuel') {
                // Ann√©es compl√®tes
                for (let y = 2025; y <= 2027; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    periodSelector.appendChild(option);
                }
            } else if (currentView === 'trimestriel') {
                // Trimestres
                const trimestres = [
                    { value: 'Q1-2026', label: 'T1 2026 (Jan-Mar)', months: [0, 1, 2] },
                    { value: 'Q2-2026', label: 'T2 2026 (Avr-Jun)', months: [3, 4, 5] },
                    { value: 'Q3-2026', label: 'T3 2026 (Jul-Sep)', months: [6, 7, 8] },
                    { value: 'Q4-2026', label: 'T4 2026 (Oct-D√©c)', months: [9, 10, 11] }
                ];
                trimestres.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.value;
                    option.textContent = t.label;
                    periodSelector.appendChild(option);
                });
            } else if (currentView === 'mensuel') {
                // Mois
                months.forEach((month, idx) => {
                    const option = document.createElement('option');
                    option.value = `${currentYear}-${String(idx + 1).padStart(2, '0')}`;
                    option.textContent = `${month} ${currentYear}`;
                    periodSelector.appendChild(option);
                });
            } else if (currentView === 'bihebdo') {
                // P√©riodes de 2 semaines
                for (let w = 1; w <= 26; w++) {
                    const startWeek = (w - 1) * 2 + 1;
                    const endWeek = startWeek + 1;
                    const option = document.createElement('option');
                    option.value = `${currentYear}-W${startWeek}`;
                    option.textContent = `Semaines ${startWeek}-${endWeek} (${currentYear})`;
                    periodSelector.appendChild(option);
                }
            }

            // S√©lectionner automatiquement la premi√®re option disponible
            if (periodSelector.options.length > 1) {
                periodSelector.selectedIndex = 1;
                // D√©clencher le chargement automatiquement
                setTimeout(() => {
                    if (periodSelector.value) {
                        generatePlanning(periodSelector.value);
                    }
                }, 100);
            }
        }

        periodSelector.addEventListener('change', () => {
            const period = periodSelector.value;
            if (!period) return;

            generatePlanning(period);
        });

        function refreshPlanning() {
            const period = periodSelector.value;
            if (!period) {
                alert('S√©lectionnez d\'abord une p√©riode');
                return;
            }
            generatePlanning(period);
        }

        async function generatePlanning(period) {
            planningTable.innerHTML = '<div class="loading">G√©n√©ration du planning...</div>';
            showProgress(10, 'R√©cup√©ration des donn√©es...');

            // Pour toutes les vues, si c'est 2026, r√©cup√©rer les donn√©es Excel mensuelles
            if (currentView === 'mensuel') {
                showProgress(30, 'Chargement du mois...');
                const [year, month] = period.split('-');
                try {
                    const response = await fetch(`/api/planning-data/${year}/${month}`);
                    showProgress(60, 'Traitement des donn√©es...');
                    const data = await response.json();

                    if (data.success) {
                        showProgress(90, 'Affichage du planning...');
                        displayMonthlyPlanning(data.agents, year, month);
                        showProgress(100, 'Termin√©!');
                        hideProgress();
                    } else {
                        planningTable.innerHTML = `<div class="loading">‚ùå ${data.error}</div>`;
                        hideProgress();
                    }
                } catch (error) {
                    planningTable.innerHTML = `<div class="loading">‚ùå ${error.message}</div>`;
                    hideProgress();
                }
            } else if (currentView === 'annuel') {
                // Vue annuelle : afficher tous les mois
                showProgress(30, 'Chargement de l\'ann√©e...');
                await displayAnnualView(period);
                showProgress(100, 'Termin√©!');
                hideProgress();
            } else if (currentView === 'trimestriel') {
                // Vue trimestrielle : afficher 3 mois
                showProgress(30, 'Chargement du trimestre...');
                await displayQuarterView(period);
                showProgress(100, 'Termin√©!');
                hideProgress();
            } else if (currentView === 'bihebdo') {
                // Vue bi-hebdo : afficher 14 jours
                showProgress(30, 'Chargement des 2 semaines...');
                await displayBiweeklyView(period);
                showProgress(100, 'Termin√©!');
                hideProgress();
            }
        } function displayMonthlyPlanning(agents, year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();

            console.log('displayMonthlyPlanning - Nombre agents re√ßus:', agents.length);
            console.log('displayMonthlyPlanning - Premiers agents:', agents.slice(0, 5).map(a => a.nom));

            // Enrichir les agents avec leurs groupes
            const enrichedAgents = agents.map(agent => {
                const nom = agent.nom.toUpperCase().trim(); // TRIM pour g√©rer les espaces
                let groupe = 'default';

                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }

                return { ...agent, groupe };
            });

            console.log('displayMonthlyPlanning - Agents enrichis:', enrichedAgents.length);
            console.log('displayMonthlyPlanning - Groupes trouv√©s:', [...new Set(enrichedAgents.map(a => a.groupe))]);

            // Filtrer par groupe si n√©cessaire
            let filteredAgents = enrichedAgents;
            if (selectedGroup !== 'all') {
                if (Array.isArray(selectedGroup)) {
                    filteredAgents = enrichedAgents.filter(a => selectedGroup.includes(a.groupe));
                } else {
                    filteredAgents = enrichedAgents.filter(a => a.groupe === selectedGroup);
                }
            }

            // Sauvegarder pour re-filtrage
            currentPlanningData = { agents: enrichedAgents, year, month, daysInMonth };

            // Trier par groupe
            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            filteredAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            let html = '<table><thead><tr>';
            html += '<th style="min-width: 150px;">Agent</th>';

            // En-t√™tes des jours
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, parseInt(month) - 1, d);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                html += `<th style="${isWeekend ? 'background: #e74c3c;' : ''}">${d}</th>`;
            }
            html += '</tr></thead><tbody>';

            // Lignes des agents avec leurs statuts
            let currentGroup = '';
            filteredAgents.forEach(agent => {
                const fullName = `${agent.nom} ${agent.prenom}`;
                const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                const colors = groupColors[agent.groupe] || groupColors.default;

                // S√©parateur de groupe (seulement si on affiche tous les groupes)
                if (selectedGroup === 'all' && currentGroup !== agent.groupe) {
                    currentGroup = agent.groupe;
                    html += `<tr><td colspan="${daysInMonth + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                }

                html += '<tr>';
                html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                    <div class="agent-name">${fullName}</div>
                    ${agentInfo ? getAgentBadges(agentInfo) : ''}
                </td>`;

                // Afficher les statuts pour chaque jour
                for (let d = 0; d < daysInMonth; d++) {
                    const date = new Date(year, parseInt(month) - 1, d + 1);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(year, parseInt(month), d + 1);

                    let status = agent.days[d] || '';

                    // Ne mettre "Pr√©sent" que si c'est un jour ouvr√© et qu'il n'y a pas de statut
                    if (!status && !isWeekend && !isFerie) {
                        status = 'Pr√©sent';
                    }

                    let cellClass = 'day-cell';
                    let cellStyle = '';
                    let cellContent = status;

                    if (isWeekend || isFerie) {
                        cellClass += ' weekend';
                        if (isFerie) {
                            cellStyle = 'background: #ff9800; color: white;';
                        } else if (isWeekend) {
                            cellStyle = 'background: #e74c3c44;';
                        }
                    } else if (status === 'P') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `P<br>${getAgentBadges(agentInfo)}`;
                        }
                    } else if (status === 'PC') {
                        cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                    } else if (status === 'F') {
                        cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                    } else if (status === 'AST') {
                        cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                    } else if (status === 'CA') {
                        cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                    } else if (status === 'RTT') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'CEX') {
                        cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                    } else if (status === 'R') {
                        cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                    } else if (status === 'M') {
                        cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                    } else if (status === 'AT') {
                        cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                    } else if (status === 'TAD') {
                        cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                    } else if (status === 'TP') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'Pr√©sent') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                        }
                    }

                    html += `<td class="${cellClass}" style="${cellStyle}" data-status="${status}"><div class="cell-inner">${cellContent}</div></td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
            setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
            // Ajuster dynamiquement les largeurs de colonnes pour √©viter la barre horizontale
            setTimeout(() => {
                try { adjustMonthlyTableToFit(); } catch (e) { console.error('adjustMonthlyTableToFit error', e); }
            }, 50);
        }

        function displayEmptyPlanning(period) {
            let html = '<table><thead><tr>';
            html += '<th style="min-width: 150px;">Agent</th>';

            // G√©n√©rer les en-t√™tes de colonnes selon la vue
            const columns = getColumnsForPeriod(period);
            columns.forEach(col => {
                html += `<th>${col.label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // G√©n√©rer les lignes d'agents
            allAgents.forEach(agent => {
                html += '<tr>';
                html += `<td class="agent-cell">
                        <div class="agent-name">${agent.fullName}</div>
                        ${getAgentBadges(agent)}
                    </td>`;

                // Cellules vides pour chaque colonne
                columns.forEach(col => {
                    const isWeekend = col.isWeekend || false;
                    html += `<td class="day-cell ${isWeekend ? 'weekend' : ''}" data-agent="${agent.index}" data-date="${col.date || ''}"><div class="cell-inner"></div></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
            setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
        }

        async function displayAnnualView(year) {
            // R√©cup√©rer les donn√©es pour tous les mois de l'ann√©e
            const allMonthsData = [];
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            for (let m = 1; m <= 12; m++) {
                showProgress(30 + (m * 5), `Chargement mois ${m}/12...`);
                try {
                    const response = await fetch(`/api/planning-data/${year}/${String(m).padStart(2, '0')}`);
                    const data = await response.json();
                    if (data.success) {
                        allMonthsData.push({
                            month: m,
                            monthName: monthNames[m - 1],
                            agents: data.agents,
                            daysInMonth: new Date(year, m, 0).getDate()
                        });
                    }
                } catch (error) {
                    console.error(`Erreur mois ${m}:`, error);
                }
            }

            if (allMonthsData.length === 0) {
                planningTable.innerHTML = '<div class="loading">Aucune donn√©e</div>';
                return;
            }

            // Enrichir et trier les agents (prendre le premier mois avec donn√©es)
            const firstMonthAgents = allMonthsData[0]?.agents || [];
            const enrichedAgents = firstMonthAgents.map(agent => {
                const nom = agent.nom.toUpperCase().trim();
                let groupe = 'default';
                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }
                return { ...agent, groupe };
            });

            // Filtrer par groupe si n√©cessaire
            let filteredAgents = enrichedAgents;
            if (selectedGroup !== 'all') {
                if (Array.isArray(selectedGroup)) {
                    filteredAgents = enrichedAgents.filter(a => selectedGroup.includes(a.groupe));
                } else {
                    filteredAgents = enrichedAgents.filter(a => a.groupe === selectedGroup);
                }
            }

            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            filteredAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            // Cr√©er une section par mois avec TOUS les jours
            let html = '';

            allMonthsData.forEach(monthData => {
                html += '<div class="month-container">';
                html += `<h3 style="margin: 20px 0 10px 0; padding: 10px; background: #3498db; color: white;">${monthData.monthName} ${year}</h3>`;
                html += '<table><thead><tr>';
                html += '<th style="min-width: 150px;">Agent</th>';

                // En-t√™tes des jours du mois
                for (let d = 1; d <= monthData.daysInMonth; d++) {
                    const date = new Date(year, monthData.month - 1, d);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(year, monthData.month, d);
                    let bgColor = '';
                    if (isFerie) bgColor = '#e67e22';
                    else if (isWeekend) bgColor = '#e74c3c';
                    html += `<th style="${bgColor ? 'background: ' + bgColor + ';' : ''}">${d}</th>`;
                }
                html += '</tr></thead><tbody>';

                // Lignes des agents avec leurs statuts pour ce mois
                let currentGroup = '';
                filteredAgents.forEach(agent => {
                    const fullName = `${agent.nom} ${agent.prenom}`;
                    const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const colors = groupColors[agent.groupe] || groupColors.default;

                    // Ligne s√©parateur de groupe
                    if (currentGroup !== agent.groupe) {
                        currentGroup = agent.groupe;
                        html += `<tr><td colspan="${monthData.daysInMonth + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                    }

                    // Trouver les donn√©es de cet agent pour ce mois
                    const agentMonth = monthData.agents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const days = agentMonth ? agentMonth.days : [];

                    html += '<tr>';
                    html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                        <div class="agent-name">${fullName}</div>
                        ${agentInfo ? getAgentBadges(agentInfo) : ''}
                    </td>`;

                    // Afficher chaque jour
                    for (let d = 1; d <= monthData.daysInMonth; d++) {
                        const date = new Date(year, monthData.month - 1, d);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isFerie = isJourFerie(year, monthData.month, d);

                        const status = days[d - 1] || '';
                        let cellContent = status;
                        let cellStyle = '';

                        // Si pas de statut et que c'est un jour travaill√©
                        if (!status && !isWeekend && !isFerie) {
                            cellContent = 'Pr√©sent';
                            cellStyle = 'background: #00ff00; color: black;';
                            if (agentInfo) {
                                cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                            }
                        } else if (status === 'P') {
                            cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        } else if (status === 'PC') {
                            cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                        } else if (status === 'F') {
                            cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                        } else if (status === 'AST') {
                            cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                        } else if (status === 'CA') {
                            cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                        } else if (status === 'RTT') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (status === 'CEX') {
                            cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                        } else if (status === 'R') {
                            cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                        } else if (status === 'M') {
                            cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                        } else if (status === 'AT') {
                            cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                        } else if (status === 'TAD') {
                            cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                        } else if (status === 'TP') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (isWeekend) {
                            cellStyle = 'background: #e74c3c44;';
                        } else if (isFerie) {
                            cellStyle = 'background: #e67e2244;';
                        }

                        html += `<td class="day-cell" style="${cellStyle}"><div class="cell-inner">${cellContent}</div></td>`;
                    }
                    html += '</tr>';
                });

                html += '</tbody></table>';
                html += '</div>'; // Fermer month-container
            });

            planningTable.innerHTML = html;
            setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
        }

        function getMonthSummary(days) {
            const counts = { PC: 0, M: 0, Present: 0 };
            days.forEach(d => {
                if (d === 'PC') counts.PC++;
                else if (d === 'M') counts.M++;
                else if (d) counts.Present++;
            });
            return `P:${counts.Present} C:${counts.PC} M:${counts.M}`;
        }

        async function displayQuarterView(quarter) {
            // Q1-2026 -> mois 1,2,3
            const quarterMap = {
                'Q1-2026': [1, 2, 3],
                'Q2-2026': [4, 5, 6],
                'Q3-2026': [7, 8, 9],
                'Q4-2026': [10, 11, 12]
            };
            const months = quarterMap[quarter] || [1, 2, 3];

            // R√©cup√©rer donn√©es des 3 mois
            const allDaysData = [];
            let monthIndex = 0;
            for (const m of months) {
                monthIndex++;
                showProgress(30 + (monthIndex * 20), `Chargement mois ${monthIndex}/3...`);
                try {
                    const response = await fetch(`/api/planning-data/2026/${String(m).padStart(2, '0')}`);
                    const data = await response.json();
                    if (data.success) {
                        const daysInMonth = new Date(2026, m, 0).getDate();
                        for (let d = 1; d <= daysInMonth; d++) {
                            allDaysData.push({
                                month: m,
                                day: d,
                                agents: data.agents
                            });
                        }
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            // Construire planning trimestriel (afficher tous les jours)
            displayMultiMonthPlanning(allDaysData, 'trimestriel');
        }

        async function displayBiweeklyView(period) {
            // Format: 2026-W1 = semaine 1 de 2026
            // L'option fournit le premier num√©ro de semaine de la p√©riode (ex: W1, W3, W5...)
            const weekStartNumber = parseInt(period.split('-W')[1]);

            // La semaine 1 de 2026 commence le 29 d√©cembre 2025 (lundi) selon ISO 8601
            const week1Start = new Date(2025, 11, 29); // 29/12/2025

            // Calculer l'index de p√©riode (1-based) √† partir du num√©ro de semaine
            // Ex: startWeek=1 -> periodIndex=1, startWeek=3 -> periodIndex=2, startWeek=5 -> periodIndex=3
            const periodIndex = Math.floor((weekStartNumber - 1) / 2) + 1;

            // Date de d√©but (lundi) de la p√©riode bihebdo demand√©e
            const startDate = new Date(week1Start);
            startDate.setDate(week1Start.getDate() + (periodIndex - 1) * 14);

            showProgress(20, 'Calcul des dates...');

            // Collecter tous les jours n√©cessaires (14 jours)
            const daysNeeded = [];
            for (let i = 0; i < 14; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                daysNeeded.push({
                    date: currentDate,
                    month: currentDate.getMonth() + 1,
                    day: currentDate.getDate(),
                    year: currentDate.getFullYear()
                });
            }

            // Identifier les mois uniques (incluant l'ann√©e) √† charger : 'YYYY-MM'
            const monthsToLoad = [...new Set(daysNeeded.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`))];
            showProgress(40, `Chargement de ${monthsToLoad.length} mois...`);

            // Charger les donn√©es pour chaque mois unique
            const monthsData = {};
            for (const monthKey of monthsToLoad) {
                const [yStr, mStr] = monthKey.split('-');
                const y = parseInt(yStr, 10);
                const m = mStr;
                try {
                    const response = await fetch(`/api/planning-data/${y}/${m}`);
                    const data = await response.json();
                    if (data.success) {
                        monthsData[monthKey] = data.agents;
                    } else {
                        monthsData[monthKey] = [];
                    }
                } catch (error) {
                    console.error('Erreur chargement mois', monthKey, error);
                    monthsData[monthKey] = [];
                }
            }

            showProgress(70, 'Traitement des donn√©es...');

            // Construire allDaysData en attachant le tableau d'agents correspondant au mois/ann√©e
            const allDaysData = daysNeeded.map(dayInfo => ({
                month: dayInfo.month,
                day: dayInfo.day,
                date: dayInfo.date,
                agents: monthsData[`${dayInfo.year}-${String(dayInfo.month).padStart(2, '0')}`] || []
            }));

            console.log('Donn√©es bihebdo:', allDaysData.length, 'jours', allDaysData[0]);
            showProgress(90, 'Affichage...');
            displayMultiMonthPlanning(allDaysData, 'bihebdo');
        }

        function displayMultiMonthPlanning(allDaysData, viewType) {
            if (allDaysData.length === 0) {
                planningTable.innerHTML = '<div class="loading">Aucune donn√©e</div>';
                return;
            }

            // Enrichir et trier les agents
            const firstDay = allDaysData[0];
            const enrichedAgents = firstDay.agents.map(agent => {
                const nom = agent.nom.toUpperCase().trim(); // TRIM pour g√©rer les espaces
                let groupe = 'default';
                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }
                return { ...agent, groupe };
            });

            // Filtrer par groupe si n√©cessaire
            let filteredAgents = enrichedAgents;
            if (selectedGroup !== 'all') {
                if (Array.isArray(selectedGroup)) {
                    filteredAgents = enrichedAgents.filter(a => selectedGroup.includes(a.groupe));
                } else {
                    filteredAgents = enrichedAgents.filter(a => a.groupe === selectedGroup);
                }
            }

            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            filteredAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            // Pour la vue trimestrielle, grouper par mois
            if (viewType === 'trimestriel') {
                const monthsData = {};
                allDaysData.forEach(dayData => {
                    if (!monthsData[dayData.month]) {
                        monthsData[dayData.month] = [];
                    }
                    monthsData[dayData.month].push(dayData);
                });

                const monthNames = ['', 'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                let html = '';

                Object.keys(monthsData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(monthNum => {
                    const monthDays = monthsData[monthNum];
                    html += '<div class="month-container">';
                    html += `<h3 style="margin: 20px 0 10px 0; padding: 10px; background: #3498db; color: white;">${monthNames[monthNum]} 2026</h3>`;
                    html += '<table><thead><tr>';
                    html += '<th style="min-width: 150px;">Agent</th>';

                    // En-t√™tes des jours
                    monthDays.forEach(dayData => {
                        const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isFerie = isJourFerie(2026, dayData.month, dayData.day);
                        html += `<th style="${isWeekend || isFerie ? 'background: ' + (isFerie ? '#ff9800' : '#e74c3c') : ''}">${dayData.day}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    // Lignes des agents
                    let currentGroup = '';
                    filteredAgents.forEach(agent => {
                        const fullName = `${agent.nom} ${agent.prenom}`;
                        const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                        const colors = groupColors[agent.groupe] || groupColors.default;

                        if (currentGroup !== agent.groupe) {
                            currentGroup = agent.groupe;
                            html += `<tr><td colspan="${monthDays.length + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                        }

                        html += '<tr>';
                        html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                            <div class="agent-name">${fullName}</div>
                            ${agentInfo ? getAgentBadges(agentInfo) : ''}
                        </td>`;

                        // Afficher le statut pour chaque jour
                        monthDays.forEach(dayData => {
                            const agentDay = dayData.agents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                            const dayIndex = dayData.day - 1;

                            const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                            const dayOfWeek = date.getDay();
                            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                            const isFerie = isJourFerie(2026, dayData.month, dayData.day);

                            let status = agentDay ? agentDay.days[dayIndex] : '';
                            let cellContent = status;

                            if (!status && !isWeekend && !isFerie) {
                                status = 'Pr√©sent';
                                cellContent = 'Pr√©sent';
                                if (agentInfo) {
                                    cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                                }
                            }

                            let cellClass = 'day-cell';
                            let cellStyle = '';
                            if (isWeekend || isFerie) {
                                cellClass += ' weekend';
                                if (isFerie) {
                                    cellStyle = 'background: #ff9800; color: white;';
                                }
                            } else if (status === 'P') {
                                cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                                if (agentInfo) {
                                    cellContent = `P<br>${getAgentBadges(agentInfo)}`;
                                }
                            } else if (status === 'PC') {
                                cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                            } else if (status === 'F') {
                                cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                            } else if (status === 'AST') {
                                cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                            } else if (status === 'CA') {
                                cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                            } else if (status === 'RTT') {
                                cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                            } else if (status === 'CEX') {
                                cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                            } else if (status === 'R') {
                                cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                            } else if (status === 'M') {
                                cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                            } else if (status === 'AT') {
                                cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                            } else if (status === 'TAD') {
                                cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                            } else if (status === 'TP') {
                                cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                            } else if (status === 'MA') {
                                cellStyle = 'background: #1abc9c; color: white; font-weight: bold;';
                            } else if (status === 'Pr√©sent') {
                                cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                                if (agentInfo) {
                                    cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                                }
                            }

                            html += `<td class="${cellClass}" style="${cellStyle}"><div class="cell-inner">${cellContent}</div></td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    html += '</div>'; // Fermer month-container
                });

                planningTable.innerHTML = html;
                setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
            } else {
                // Vue bihebdo - tableau unique
                let html = '<table><thead><tr>';
                html += '<th style="min-width: 150px;">Agent</th>';

                // En-t√™tes des jours
                allDaysData.forEach(dayData => {
                    const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(2026, dayData.month, dayData.day);
                    html += `<th style="${isWeekend || isFerie ? 'background: ' + (isFerie ? '#ff9800' : '#e74c3c') : ''}">${dayData.day}/${dayData.month}</th>`;
                });
                html += '</tr></thead><tbody>';

                // Lignes des agents
                let currentGroup = '';
                filteredAgents.forEach(agent => {
                    const fullName = `${agent.nom} ${agent.prenom}`;
                    const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const colors = groupColors[agent.groupe] || groupColors.default;

                    if (currentGroup !== agent.groupe) {
                        currentGroup = agent.groupe;
                        html += `<tr><td colspan="${allDaysData.length + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                    }

                    html += '<tr>';
                    html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                        <div class="agent-name">${fullName}</div>
                        ${agentInfo ? getAgentBadges(agentInfo) : ''}
                    </td>`;

                    // Afficher le statut pour chaque jour
                    allDaysData.forEach(dayData => {
                        const agentDay = dayData.agents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                        const dayIndex = dayData.day - 1;

                        const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isFerie = isJourFerie(2026, dayData.month, dayData.day);

                        let status = agentDay ? agentDay.days[dayIndex] : '';
                        let cellContent = status;

                        if (!status && !isWeekend && !isFerie) {
                            status = 'Pr√©sent';
                            cellContent = 'Pr√©sent';
                            if (agentInfo) {
                                cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                            }
                        }

                        let cellClass = 'day-cell';
                        let cellStyle = '';
                        if (isWeekend || isFerie) {
                            cellClass += ' weekend';
                            if (isFerie) {
                                cellStyle = 'background: #ff9800; color: white;';
                            }
                        } else if (status === 'P') {
                            cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                            if (agentInfo) {
                                cellContent = `P<br>${getAgentBadges(agentInfo)}`;
                            }
                        } else if (status === 'PC') {
                            cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                        } else if (status === 'F') {
                            cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                        } else if (status === 'AST') {
                            cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                        } else if (status === 'CA') {
                            cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                        } else if (status === 'RTT') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (status === 'CEX') {
                            cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                        } else if (status === 'R') {
                            cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                        } else if (status === 'M') {
                            cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                        } else if (status === 'AT') {
                            cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                        } else if (status === 'TAD') {
                            cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                        } else if (status === 'TP') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (status === 'Pr√©sent') {
                            cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                            if (agentInfo) {
                                cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                            }
                        }

                        html += `<td class="${cellClass}" style="${cellStyle}"><div class="cell-inner">${cellContent}</div></td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                planningTable.innerHTML = html;
                setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
            }
        }

        function getAgentBadges(agent) {
            const badges = [];
            const seen = new Set();

            agent.aptitudes.forEach(apt => {
                const nomLower = apt.nom ? apt.nom.toLowerCase() : '';

                // Filtrer anniversaire et visites
                if (nomLower.includes('anniversaire') || nomLower.includes('visite') ||
                    nomLower.includes('derni√®re') || nomLower.includes('prochaine') ||
                    nomLower.includes('derniere')) {
                    return;
                }

                let badgeClass = '';
                let badgeText = '';
                const val = apt.valeur ? String(apt.valeur) : '';

                // Correspondances plus larges : utiliser le nom de l'en-t√™te (header) pour d√©cider
                if (nomLower.includes('r.482') || nomLower.includes('r482') || nomLower.includes('caces')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('grue') || nomLower.includes('nacelle') || nomLower.includes('r.490') || nomLower.includes('nacelle')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('chariot') || nomLower.includes('r.489')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('tondeuse')) {
                    badgeClass = 'badge-tondeuse';
                    badgeText = 'Tn';
                } else if (nomLower.includes('tron√ßo') || nomLower.includes('tronco')) {
                    badgeClass = 'badge-tronco';
                    badgeText = 'T';
                } else if (nomLower.includes('permis') || nomLower.includes('remorque') || nomLower.includes('perm')) {
                    badgeClass = 'badge-permis';
                    badgeText = 'P';
                } else if (nomLower.includes('aipr')) {
                    badgeClass = 'badge-aipr';
                    badgeText = 'A';
                } else if (nomLower.includes('fimo')) {
                    badgeClass = 'badge-fimo';
                    badgeText = 'F';
                } else if (nomLower.includes('secours') || nomLower.includes('premiers secours')) {
                    badgeClass = 'badge-secours';
                    badgeText = 'S';
                } else {
                    // Si l'en-t√™te n'est pas reconnu mais la valeur est pr√©sente, cr√©er une pastille g√©n√©rique
                    if (val && val !== '‚úì') {
                        badgeClass = 'badge-generic';
                        // texte court bas√© sur le header (2-3 chars)
                        const words = nomLower.split(/\s+/);
                        badgeText = (words[0] || '').substring(0, 3).toUpperCase();
                    }
                }

                if (badgeClass && badgeText && !seen.has(badgeText)) {
                    const title = val && val !== '‚úì' ? `${apt.nom}: ${val}` : apt.nom;
                    badges.push({ class: badgeClass, text: badgeText, title });
                    seen.add(badgeText);
                }
            });

            if (badges.length === 0) return '';

            return '<div class="agent-badges">' +
                badges.map(b => `<span class="badge-mini ${b.class}" title="${b.title}">${b.text}</span>`).join('') +
                '</div>';
        }

        function getColumnsForPeriod(period) {
            if (currentView === 'annuel') {
                // 12 mois de l'ann√©e
                const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jui', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
                return months.map((m, idx) => ({
                    label: m,
                    date: `${period}-${String(idx + 1).padStart(2, '0')}`
                }));
            } else if (currentView === 'trimestriel') {
                // 3 mois avec environ 13 semaines chacun
                const columns = [];
                const quarterMonths = {
                    'Q1-2026': ['Janvier', 'F√©vrier', 'Mars'],
                    'Q2-2026': ['Avril', 'Mai', 'Juin'],
                    'Q3-2026': ['Juillet', 'Ao√ªt', 'Septembre'],
                    'Q4-2026': ['Octobre', 'Novembre', 'D√©cembre']
                };

                const months = quarterMonths[period] || ['Jan', 'F√©v', 'Mar'];
                months.forEach(month => {
                    // 4-5 semaines par mois
                    for (let w = 1; w <= 4; w++) {
                        columns.push({
                            label: `${month.substring(0, 3)} S${w}`,
                            date: `${month}-W${w}`
                        });
                    }
                });
                return columns;
            } else if (currentView === 'mensuel') {
                // Tous les jours du mois
                const [year, month] = period.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                const columns = [];

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, parseInt(month) - 1, d);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    columns.push({
                        label: d.toString(),
                        date: `${year}-${month}-${String(d).padStart(2, '0')}`,
                        isWeekend
                    });
                }
                return columns;
            } else if (currentView === 'bihebdo') {
                // 14 jours (2 semaines)
                const columns = [];
                const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

                for (let d = 0; d < 14; d++) {
                    const dayOfWeek = d % 7;
                    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                    const weekNum = Math.floor(d / 7) + 1;

                    columns.push({
                        label: `S${weekNum} ${dayNames[dayOfWeek]}`,
                        date: `W${weekNum}-D${d + 1}`,
                        isWeekend
                    });
                }
                return columns;
            }
            return [];
        }

        function toggleAllGroups(checkbox) {
            const checkboxes = document.querySelectorAll('.groupCheckbox:not([value="all"])');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            filterByGroup();
        }

        function filterByGroup() {
            const checkboxes = document.querySelectorAll('.groupCheckbox:not([value="all"])');
            const selectedGroups = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Mettre √† jour la checkbox "Tous"
            const allCheckbox = document.querySelector('.groupCheckbox[value="all"]');
            if (allCheckbox) {
                allCheckbox.checked = selectedGroups.length === checkboxes.length;
            }

            selectedGroup = selectedGroups.length === checkboxes.length ? 'all' : selectedGroups;

            // Re-afficher le planning avec le filtre
            if (currentPlanningData) {
                displayMonthlyPlanning(currentPlanningData.agents.map(a => ({
                    nom: a.nom,
                    prenom: a.prenom,
                    matricule: a.matricule,
                    days: a.days
                })), currentPlanningData.year, currentPlanningData.month);
            }
        }

        // Gestion de l'orientation d'impression
        document.getElementById('printOrientation').addEventListener('change', function () {
            const orientation = this.value;
            document.body.classList.remove('landscape-print', 'portrait-print');
            document.body.classList.add(orientation + '-print');

            // Mettre √† jour le style @page dynamiquement
            let styleSheet = document.getElementById('dynamic-print-style');
            if (!styleSheet) {
                styleSheet = document.createElement('style');
                styleSheet.id = 'dynamic-print-style';
                document.head.appendChild(styleSheet);
            }

            if (orientation === 'landscape') {
                styleSheet.textContent = '@media print { @page { size: A3 landscape; } }';
            } else {
                styleSheet.textContent = '@media print { @page { size: A3 portrait; } }';
            }
        });

        // Modal de g√©n√©ration
        function showGenerateModal() {
            document.getElementById('generateModal').style.display = 'block';
        }

        function closeGenerateModal() {
            document.getElementById('generateModal').style.display = 'none';
        }

        async function generatePlanningFromModal() {
            const week = document.getElementById('generateWeek').value;
            const teamSize = document.getElementById('teamSize').value;

            if (!week) {
                alert('Veuillez s√©lectionner une semaine');
                return;
            }

            closeGenerateModal();
            planningTable.innerHTML = '<div class="loading">G√©n√©ration du planning...</div>';

            try {
                const response = await fetch('/api/generate-teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week, teamSize })
                });

                if (response.headers.get('content-type')?.includes('spreadsheet')) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `planning_semaine_${week}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    planningTable.innerHTML = '<div class="loading">‚úÖ Planning g√©n√©r√© et t√©l√©charg√© !</div>';
                } else {
                    const data = await response.json();
                    planningTable.innerHTML = `<div class="loading">‚ùå ${data.error || 'Erreur'}</div>`;
                }
            } catch (error) {
                planningTable.innerHTML = `<div class="loading">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Fermer modal au clic ext√©rieur
        window.onclick = function (event) {
            const modal = document.getElementById('generateModal');
            if (event.target === modal) {
                closeGenerateModal();
            }
        }

        // Fonction pour charger un planning Excel
        async function loadExcelPlanning(event) {
            const file = event.target.files[0];
            if (!file) return;

            planningTable.innerHTML = '<div class="loading">Chargement du fichier Excel...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/load-planning', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayUploadedPlanning(data);
                } else {
                    planningTable.innerHTML = `<div class="loading">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                planningTable.innerHTML = `<div class="loading">‚ùå Erreur: ${error.message}</div>`;
            }

            // R√©initialiser l'input
            event.target.value = '';
        }

        function displayUploadedPlanning(data) {
            // Afficher les donn√©es du planning upload√©
            let html = `<h3 style="margin: 0 0 20px 0; padding: 10px; background: #3498db; color: white;">${data.title || 'Planning charg√©'}</h3>`;
            html += '<table><thead><tr>';

            // En-t√™tes
            data.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Lignes de donn√©es
            data.rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, idx) => {
                    const cellValue = cell || '';
                    let cellStyle = '';

                    // Coloration selon contenu (optionnel)
                    if (idx === 0) {
                        cellStyle = 'font-weight: bold; background: #f8f9fa;';
                    }

                    html += `<td class="day-cell" style="${cellStyle}"><div class="cell-inner">${cellValue}</div></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
            setTimeout(() => { try { adjustAllTablesToFit(); } catch (e) { console.error(e); } }, 50);
        }

        // Ajuste la table mensuelle pour qu'elle tienne dans la fen√™tre (pas de scrollbar horizontale)
        function adjustMonthlyTableToFit() {
            const container = document.querySelector('.planning-container');
            const table = planningTable.querySelector('table');
            if (!container || !table) return;

            // Forcer table-layout fixed pour appliquer des largeurs
            table.style.tableLayout = 'fixed';

            // Calculer largeur disponible (prendre en compte padding)
            const containerStyle = getComputedStyle(container);
            const containerPadding = parseFloat(containerStyle.paddingLeft || 0) + parseFloat(containerStyle.paddingRight || 0);
            const availableWidth = Math.max(300, container.clientWidth - containerPadding);

            // Nombre de colonnes jours = th count - 1 (col agent)
            const thead = table.querySelector('thead');
            if (!thead) return;
            const ths = thead.querySelectorAll('th');
            if (ths.length < 2) return;

            const dayCols = ths.length - 1;

            // Estimer largeur colonne agent (prendre la largeur actuelle ou min 140)
            const agentColWidth = Math.min(360, Math.max(140, ths[0].offsetWidth || 220));

            // Espace disponible pour les jours
            const spaceForDays = Math.max(100, availableWidth - agentColWidth - 20);
            let dayWidth = Math.floor(spaceForDays / dayCols);

            // Ne pas rendre les colonnes trop petites
            if (dayWidth < 32) {
                dayWidth = 32;
                table.style.fontSize = '12px';
            } else {
                table.style.fontSize = '';
            }

            // Cr√©er/mettre √† jour <colgroup>
            let colgroup = table.querySelector('colgroup');
            if (!colgroup) {
                colgroup = document.createElement('colgroup');
                table.insertBefore(colgroup, table.firstChild);
            }
            colgroup.innerHTML = '';

            const colAgent = document.createElement('col');
            colAgent.style.width = agentColWidth + 'px';
            colgroup.appendChild(colAgent);

            for (let i = 0; i < dayCols; i++) {
                const c = document.createElement('col');
                c.style.width = dayWidth + 'px';
                colgroup.appendChild(c);
            }

            // Masquer le scroll horizontal si possible
            container.style.overflowX = 'hidden';

            // Fixer la hauteur des cellules jour pour obtenir des cases r√©guli√®res
            try {
                const dayCells = table.querySelectorAll('td.day-cell');
                const targetHeight = dayWidth; // hauteur en px = largeur des jours
                dayCells.forEach(td => {
                    td.style.height = targetHeight + 'px';
                    // assurer que l'int√©rieur prend toute la hauteur
                    const inner = td.querySelector('.cell-inner');
                    if (inner) inner.style.height = '100%';
                });

                // Ajuster la ligne header height au besoin
                const thead = table.querySelector('thead');
                if (thead) {
                    const ths = thead.querySelectorAll('th');
                    ths.forEach(th => { th.style.height = 'auto'; });
                }
            } catch (e) {
                console.error('Erreur r√©glage hauteur cellules:', e);
            }
        }

        // Ajuste toutes les tables pr√©sentes dans la zone de planning
        function adjustAllTablesToFit() {
            const container = document.querySelector('.planning-container');
            if (!container) return;
            const tables = planningTable.querySelectorAll('table');
            tables.forEach(table => {
                try {
                    table.style.tableLayout = 'fixed';
                    const containerStyle = getComputedStyle(container);
                    const containerPadding = parseFloat(containerStyle.paddingLeft || 0) + parseFloat(containerStyle.paddingRight || 0);
                    const availableWidth = Math.max(300, container.clientWidth - containerPadding);

                    const thead = table.querySelector('thead');
                    if (!thead) return;
                    const ths = thead.querySelectorAll('th');
                    if (ths.length < 2) return;

                    const dayCols = ths.length - 1;
                    const agentColWidth = Math.min(360, Math.max(140, ths[0].offsetWidth || 220));
                    const spaceForDays = Math.max(100, availableWidth - agentColWidth - 20);
                    let dayWidth = Math.floor(spaceForDays / dayCols);
                    if (dayWidth < 32) {
                        dayWidth = 32;
                        table.style.fontSize = '12px';
                    } else {
                        table.style.fontSize = '';
                    }

                    let colgroup = table.querySelector('colgroup');
                    if (!colgroup) {
                        colgroup = document.createElement('colgroup');
                        table.insertBefore(colgroup, table.firstChild);
                    }
                    colgroup.innerHTML = '';
                    const colAgent = document.createElement('col');
                    colAgent.style.width = agentColWidth + 'px';
                    colgroup.appendChild(colAgent);
                    for (let i = 0; i < dayCols; i++) {
                        const c = document.createElement('col');
                        c.style.width = dayWidth + 'px';
                        colgroup.appendChild(c);
                    }

                    // set explicit heights to make boxes roughly square
                    const dayCells = table.querySelectorAll('td.day-cell');
                    const targetHeight = dayWidth;
                    dayCells.forEach(td => {
                        td.style.height = targetHeight + 'px';
                        const inner = td.querySelector('.cell-inner');
                        if (inner) inner.style.height = '100%';
                    });

                } catch (e) {
                    console.error('adjustAllTablesToFit error', e);
                }
            });

            // hide horizontal scroll when possible
            container.style.overflowX = 'hidden';
        }

        // Debounce helper
        function debounce(fn, wait) {
            let t;
            return function () {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, arguments), wait);
            };
        }

        // Ajuster au redimensionnement
        window.addEventListener('resize', debounce(() => {
            try { adjustMonthlyTableToFit(); } catch (e) { /* ignore */ }
        }, 120));

        // --- PRINT HELPERS -------------------------------------------------
        // When printing, browsers may use the inline heights we set via JS.
        // Remove those fixed heights before printing so the layout can reflow
        // and avoid random truncation of cells. Restore / recompute after print.
        function prepareForPrint() {
            try {
                document.body.classList.add('printing');

                // Clear inline heights set on day-cell and cell-inner so print engine uses auto height
                document.querySelectorAll('.planning-container table td.day-cell').forEach(td => {
                    // save for restore if needed
                    if (td.style.height) td.dataset._savedHeight = td.style.height;
                    td.style.height = 'auto';
                    const inner = td.querySelector('.cell-inner');
                    if (inner) {
                        if (inner.style.height) inner.dataset._savedHeight = inner.style.height;
                        inner.style.height = 'auto';
                        inner.style.overflow = 'visible';
                    }
                });

                // set table-layout to auto to let print engine distribute width best
                document.querySelectorAll('.planning-container table').forEach(t => {
                    if (t.style.tableLayout) t.dataset._savedTableLayout = t.style.tableLayout;
                    t.style.tableLayout = 'auto';

                    // save and clear colgroup widths so print engine can auto-size
                    const cg = t.querySelector('colgroup');
                    if (cg) {
                        if (!cg.dataset._savedInner) cg.dataset._savedInner = cg.innerHTML || '';
                        cg.innerHTML = '';
                    }

                    // compute scaling to fit printable area
                    try {
                        const scrollW = t.scrollWidth || t.offsetWidth || 0;
                        const container = document.querySelector('.planning-container');
                        const containerStyle = getComputedStyle(container);
                        const containerPadding = parseFloat(containerStyle.paddingLeft || 0) + parseFloat(containerStyle.paddingRight || 0);
                        const available = Math.max(300, container.clientWidth - containerPadding);
                        let scale = 1;
                        if (scrollW > available) {
                            scale = available / scrollW;
                        }
                        // store previous transform
                        if (t.style.transform) t.dataset._savedTransform = t.style.transform;
                        if (scale < 0.995) {
                            t.style.transformOrigin = 'top left';
                            t.style.transform = `scale(${scale})`;
                            // ensure there's no overflow clipping in preview
                            t.style.marginLeft = '0';
                        }
                    } catch (e) {
                        console.debug('print scale compute failed', e);
                    }
                });
            } catch (e) {
                console.error('prepareForPrint error', e);
            }
        }

        function afterPrintCleanup() {
            try {
                document.body.classList.remove('printing');

                // restore saved colgroups and transforms (if any) then recompute
                document.querySelectorAll('.planning-container table').forEach(t => {
                    // restore colgroup content
                    const cg = t.querySelector('colgroup');
                    if (cg && cg.dataset._savedInner !== undefined) {
                        cg.innerHTML = cg.dataset._savedInner || '';
                        delete cg.dataset._savedInner;
                    }
                    // restore transform
                    if (t.dataset._savedTransform !== undefined) {
                        t.style.transform = t.dataset._savedTransform || '';
                        delete t.dataset._savedTransform;
                    } else {
                        t.style.transform = '';
                    }
                });

                // Recompute sizes for interactive view after a short delay
                setTimeout(() => adjustAllTablesToFit(), 200);
            } catch (e) {
                console.error('afterPrintCleanup error', e);
            }
        }

        if (window.matchMedia) {
            const mql = window.matchMedia('print');
            mql.addListener(mq => {
                if (mq.matches) prepareForPrint(); else afterPrintCleanup();
            });
        }

        window.onbeforeprint = prepareForPrint;
        window.onafterprint = afterPrintCleanup;

        // Charger les agents au d√©marrage
        loadAgents().then(() => {
            updatePeriodSelector();
        });
    </script>
</body>

</html>