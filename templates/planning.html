<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning - ST88</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 32px;
        }

        nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        nav a {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #2c3e50;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        nav a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .view-tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            color: #2c3e50;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-print {
            background: #2ecc71;
            color: white;
        }

        .planning-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
            min-width: 35px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .agent-cell {
            font-weight: 600;
            text-align: left;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 150px;
            padding: 8px;
        }

        .agent-name {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .agent-badges {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .badge-mini {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            font-size: 8px;
            font-weight: bold;
            color: white;
            line-height: 16px;
            text-align: center;
        }

        .badge-caces {
            background: #f39c12;
        }

        .badge-permis {
            background: #e74c3c;
        }

        .badge-aipr {
            background: #3498db;
        }

        .badge-fimo {
            background: #9b59b6;
        }

        .badge-tronco {
            background: #95a5a6;
        }

        .badge-secours {
            background: #e67e22;
        }

        .day-cell {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .day-cell:hover {
            background: #e3f2fd;
        }

        .day-cell.weekend {
            background: #ffe0e0;
        }

        .day-cell.present {
            background: #d4edda;
        }

        .day-cell.absent {
            background: #f8d7da;
        }

        .day-cell.conge {
            background: #fff3cd;
        }

        tr:nth-child(even) .agent-cell {
            background: #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-content label {
            display: block;
            margin: 15px 0 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-generate {
            background: #9b59b6;
            color: white;
        }

        @media print {
            @page {
                size: A3 landscape;
                margin: 3mm;
            }

            body.portrait-print @page {
                size: A3 portrait;
                margin: 3mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0;
                margin: 0;
                width: 100%;
            }

            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            header nav,
            .controls,
            .view-tabs,
            header>div:first-child {
                display: none !important;
            }

            header {
                padding: 5px 0 !important;
                margin: 0 !important;
            }

            header h1 {
                font-size: 12px !important;
                margin: 2px 0 !important;
                text-align: center;
                color: black !important;
            }

            .planning-container {
                box-shadow: none;
                border-radius: 0;
                padding: 0 !important;
                margin: 0 !important;
                width: 100%;
                overflow: visible !important;
            }

            #planningTable {
                width: 100% !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .agent-badges {
                display: flex !important;
            }

            table {
                font-size: 6px !important;
                width: 100% !important;
                table-layout: auto !important;
                border-collapse: collapse !important;
                page-break-inside: auto;
                margin: 0 !important;
            }

            thead {
                display: table-header-group;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            th,
            td {
                padding: 1px !important;
                border: 0.3pt solid #333 !important;
                font-size: 6px !important;
                line-height: 1.2 !important;
            }

            th {
                background: #667eea !important;
                color: white !important;
                font-weight: bold !important;
                padding: 2px 1px !important;
            }

            .agent-cell {
                font-size: 6px !important;
                max-width: 70px !important;
                min-width: 70px !important;
                width: 70px !important;
                padding: 1px !important;
            }

            .agent-name {
                font-size: 6px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin: 0 !important;
            }

            .badge-mini {
                width: 10px !important;
                height: 10px !important;
                font-size: 5px !important;
                line-height: 10px !important;
                margin: 0 !important;
                padding: 0 !important;
                display: inline-block !important;
            }

            .day-cell {
                text-align: center !important;
                font-size: 6px !important;
                padding: 1px !important;
            }

            br {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìÖ Planning</h1>

            <nav>
                <a href="/">Agents</a>
                <a href="/planning" class="active">Planning</a>
                <a href="/generator">G√©n√©rateur</a>
            </nav>

            <div class="view-tabs">
                <button class="view-tab" onclick="changeView('annuel')">üìÜ Annuel</button>
                <button class="view-tab" onclick="changeView('trimestriel')">üìä Trimestriel</button>
                <button class="view-tab active" onclick="changeView('mensuel')">üìÖ Mensuel</button>
                <button class="view-tab" onclick="changeView('bihebdo')">üìã Bi-hebdo</button>
            </div>

            <div class="controls">
                <select id="groupFilter" onchange="filterByGroup()">
                    <option value="all">Tous les groupes</option>
                    <option value="Encadrant">Encadrant</option>
                    <option value="Surveillant de travaux">Surveillant de travaux</option>
                    <option value="Encadrant Propret√©">Encadrant Propret√©</option>
                    <option value="Agents Voirie">Agents Voirie</option>
                    <option value="Agent EV">Agent EV</option>
                    <option value="COMMUN - Magasinier">COMMUN - Magasinier</option>
                </select>

                <select id="periodSelector">
                    <option value="">S√©lectionner une p√©riode...</option>
                </select>

                <input type="file" id="excelUpload" accept=".xlsx,.xlsm" style="display: none;"
                    onchange="loadExcelPlanning(event)">
                <button class="btn-print" onclick="document.getElementById('excelUpload').click()"
                    style="background: #3498db;">üìÇ Charger Excel</button>

                <button class="btn-print" onclick="showGenerateModal()" style="background: #9b59b6;">‚ö°
                    G√©n√©rer Planning</button>

                <select id="printOrientation" style="min-width: 150px;">
                    <option value="portrait">A3 Portrait</option>
                    <option value="landscape">A3 Paysage</option>
                </select>

                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer</button>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; align-items: center;">
                <div style="font-weight: 600; color: #2c3e50;">L√©gende :</div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #00ff00; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Pr√©sence (P)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff00ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Pr√©v Cong√©s (PC)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #8000ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Formation (F)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #0000ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Astreinte (AST)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff00; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Cong√©s Annuel (CA)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff80; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">RTT</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #00ffff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Cong√©s Exc (CEX)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff0000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">R√©serve (R)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff8000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Maladie (M)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff4000; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Accident Travail (AT)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #0080ff; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Travail Distance (TAD)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ffff80; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Temps Partiel (TP)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #1abc9c; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">MA</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #e74c3c; opacity: 0.3; border-radius: 4px;">
                    </div>
                    <span style="font-size: 14px;">Week-end</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 20px; height: 20px; background: #ff9800; border-radius: 4px;"></div>
                    <span style="font-size: 14px;">Jour f√©ri√©</span>
                </div>
            </div>
        </header>

        <!-- Modal de g√©n√©ration -->
        <div id="generateModal" class="modal">
            <div class="modal-content">
                <h2>‚ö° G√©n√©rer un Planning</h2>
                <label for="generateWeek">Semaine :</label>
                <input type="week" id="generateWeek" required>

                <label for="teamSize">Agents par √©quipe :</label>
                <select id="teamSize">
                    <option value="2">2 agents</option>
                    <option value="3" selected>3 agents</option>
                </select>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeGenerateModal()">Annuler</button>
                    <button class="btn-generate" onclick="generatePlanningFromModal()">G√©n√©rer</button>
                </div>
            </div>
        </div>

        <div class="planning-container">
            <div id="planningTable" class="loading">
                S√©lectionnez une p√©riode pour afficher le planning
            </div>
        </div>
    </div>

    <script>
        let currentView = 'mensuel';
        let allAgents = [];
        let selectedGroup = 'all';
        let currentPlanningData = null;

        const periodSelector = document.getElementById('periodSelector');
        const planningTable = document.getElementById('planningTable');

        const groupes = {
            'Encadrant': ['DEBREYNE', 'LUTARD', 'HAUTDECOEUR', 'GRENET', 'FOURCADE', 'GONCALVES', 'SIGALA', 'BETTINGER', 'TUCOULET', 'VRBOVSKA'],
            'Surveillant de travaux': ['BOURGOIN', 'MERCADIEU', 'GARCIA', 'LARROUDE', 'SAMITIER', 'PIEL'],
            'Encadrant Propret√©': ['GOURVIAT', 'LARTIGUE', 'TRIQUENEAUX', 'ESPERON', 'ROUGLAN', 'NOURRI'],
            'Agents Voirie': ['BERRIO-GAUDNER', 'FONTENEAU', 'GUIJARRO', 'GOUREAU', 'LABORIE', 'LARRIEU', 'LEVIGNAT', 'MARTIN-HERNANDEZ', 'PIERRE', 'SOLA', 'WEISS'],
            'Agent EV': ['DELANDE', 'DA SILVA REIS', 'ELMAGROUD', 'ESTEVE', 'KADRI', 'MALLET', 'MAURY', 'MOINGT', 'REY', 'TADJROUNA', 'VILLENEUVE'],
            'COMMUN - Magasinier': ['VOL', 'GENNA', 'BERNARD', 'HAUBRAICHE']
        };

        const groupColors = {
            'Encadrant': { bg: '#f093fb', border: '#f5576c' },
            'Surveillant de travaux': { bg: '#a8edea', border: '#a8edea' },
            'Encadrant Propret√©': { bg: '#72EDF2', border: '#5151E5' },
            'Agents Voirie': { bg: '#4facfe', border: '#00f2fe' },
            'Agent EV': { bg: '#43e97b', border: '#38f9d7' },
            'COMMUN - Magasinier': { bg: '#fa709a', border: '#fee140' },
            'default': { bg: '#667eea', border: '#764ba2' }
        };

        // Jours f√©ri√©s 2026 en France
        const joursFeries2026 = [
            '2026-01-01', // Jour de l'an
            '2026-04-06', // Lundi de P√¢ques
            '2026-05-01', // F√™te du travail
            '2026-05-08', // Victoire 1945
            '2026-05-14', // Ascension
            '2026-05-25', // Lundi de Pentec√¥te
            '2026-07-14', // F√™te nationale
            '2026-08-15', // Assomption
            '2026-11-01', // Toussaint
            '2026-11-11', // Armistice 1918
            '2026-12-25'  // No√´l
        ];

        function isJourFerie(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return joursFeries2026.includes(dateStr);
        }

        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    allAgents = data.agents.map((agent, index) => {
                        const aptitudes = [];
                        agent.data.forEach((val, idx) => {
                            const header = data.headers[idx];
                            if (header && idx >= 7) {
                                // Accepter toute valeur non vide comme aptitude : date, 'x', texte libre (ex: 'Dec-28')
                                if (val !== null && val !== undefined && String(val).toString().trim() !== '') {
                                    let dateObj = null;
                                    let display = '';

                                    // Essayer de parser en date
                                    const parsed = new Date(val);
                                    if (!isNaN(parsed.getTime())) {
                                        dateObj = parsed;
                                        try {
                                            display = parsed.toLocaleDateString('fr-FR');
                                        } catch (e) {
                                            display = String(val);
                                        }
                                    } else if (typeof val === 'string' && val.trim().toLowerCase() === 'x') {
                                        display = '‚úì';
                                    } else {
                                        display = String(val).trim();
                                    }

                                    aptitudes.push({
                                        nom: header,
                                        valeur: display,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        });

                        const nom = agent.nom.toUpperCase().trim(); // TRIM
                        let groupe = 'default';

                        for (const [groupeName, noms] of Object.entries(groupes)) {
                            if (noms.some(n => nom === n)) {
                                groupe = groupeName;
                                break;
                            }
                        }

                        return {
                            index,
                            matricule: agent.matricule,
                            nom: agent.nom,
                            prenom: agent.prenom,
                            fullName: `${agent.nom} ${agent.prenom}`,
                            aptitudes,
                            groupe
                        };
                    });
                }
            } catch (error) {
                console.error('Erreur chargement agents:', error);
            }
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            updatePeriodSelector();
            planningTable.innerHTML = '<div class="loading">S√©lectionnez une p√©riode</div>';
        }

        function updatePeriodSelector() {
            periodSelector.innerHTML = '<option value="">S√©lectionner une p√©riode...</option>';

            const currentYear = 2026;
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            if (currentView === 'annuel') {
                // Ann√©es compl√®tes
                for (let y = 2025; y <= 2027; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    periodSelector.appendChild(option);
                }
            } else if (currentView === 'trimestriel') {
                // Trimestres
                const trimestres = [
                    { value: 'Q1-2026', label: 'T1 2026 (Jan-Mar)', months: [0, 1, 2] },
                    { value: 'Q2-2026', label: 'T2 2026 (Avr-Jun)', months: [3, 4, 5] },
                    { value: 'Q3-2026', label: 'T3 2026 (Jul-Sep)', months: [6, 7, 8] },
                    { value: 'Q4-2026', label: 'T4 2026 (Oct-D√©c)', months: [9, 10, 11] }
                ];
                trimestres.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.value;
                    option.textContent = t.label;
                    periodSelector.appendChild(option);
                });
            } else if (currentView === 'mensuel') {
                // Mois
                months.forEach((month, idx) => {
                    const option = document.createElement('option');
                    option.value = `${currentYear}-${String(idx + 1).padStart(2, '0')}`;
                    option.textContent = `${month} ${currentYear}`;
                    periodSelector.appendChild(option);
                });
            } else if (currentView === 'bihebdo') {
                // P√©riodes de 2 semaines
                for (let w = 1; w <= 26; w++) {
                    const startWeek = (w - 1) * 2 + 1;
                    const endWeek = startWeek + 1;
                    const option = document.createElement('option');
                    option.value = `${currentYear}-W${startWeek}`;
                    option.textContent = `Semaines ${startWeek}-${endWeek} (${currentYear})`;
                    periodSelector.appendChild(option);
                }
            }
        }

        periodSelector.addEventListener('change', () => {
            const period = periodSelector.value;
            if (!period) return;

            generatePlanning(period);
        });

        async function generatePlanning(period) {
            planningTable.innerHTML = '<div class="loading">G√©n√©ration du planning...</div>';

            // Pour toutes les vues, si c'est 2026, r√©cup√©rer les donn√©es Excel mensuelles
            if (currentView === 'mensuel') {
                const [year, month] = period.split('-');
                try {
                    const response = await fetch(`/api/planning-data/${year}/${month}`);
                    const data = await response.json();

                    if (data.success) {
                        displayMonthlyPlanning(data.agents, year, month);
                    } else {
                        planningTable.innerHTML = `<div class="loading">‚ùå ${data.error}</div>`;
                    }
                } catch (error) {
                    planningTable.innerHTML = `<div class="loading">‚ùå ${error.message}</div>`;
                }
            } else if (currentView === 'annuel') {
                // Vue annuelle : afficher tous les mois
                displayAnnualView(period);
            } else if (currentView === 'trimestriel') {
                // Vue trimestrielle : afficher 3 mois
                displayQuarterView(period);
            } else if (currentView === 'bihebdo') {
                // Vue bi-hebdo : afficher 14 jours
                displayBiweeklyView(period);
            }
        } function displayMonthlyPlanning(agents, year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();

            console.log('displayMonthlyPlanning - Nombre agents re√ßus:', agents.length);
            console.log('displayMonthlyPlanning - Premiers agents:', agents.slice(0, 5).map(a => a.nom));

            // Enrichir les agents avec leurs groupes
            const enrichedAgents = agents.map(agent => {
                const nom = agent.nom.toUpperCase().trim(); // TRIM pour g√©rer les espaces
                let groupe = 'default';

                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }

                return { ...agent, groupe };
            });

            console.log('displayMonthlyPlanning - Agents enrichis:', enrichedAgents.length);
            console.log('displayMonthlyPlanning - Groupes trouv√©s:', [...new Set(enrichedAgents.map(a => a.groupe))]);

            // Filtrer par groupe si n√©cessaire
            let filteredAgents = enrichedAgents;
            if (selectedGroup !== 'all') {
                filteredAgents = enrichedAgents.filter(a => a.groupe === selectedGroup);
            }

            // Sauvegarder pour re-filtrage
            currentPlanningData = { agents: enrichedAgents, year, month, daysInMonth };

            // Trier par groupe
            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            filteredAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            let html = '<table><thead><tr>';
            html += '<th style="min-width: 150px;">Agent</th>';

            // En-t√™tes des jours
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, parseInt(month) - 1, d);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                html += `<th style="${isWeekend ? 'background: #e74c3c;' : ''}">${d}</th>`;
            }
            html += '</tr></thead><tbody>';

            // Lignes des agents avec leurs statuts
            let currentGroup = '';
            filteredAgents.forEach(agent => {
                const fullName = `${agent.nom} ${agent.prenom}`;
                const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                const colors = groupColors[agent.groupe] || groupColors.default;

                // S√©parateur de groupe (seulement si on affiche tous les groupes)
                if (selectedGroup === 'all' && currentGroup !== agent.groupe) {
                    currentGroup = agent.groupe;
                    html += `<tr><td colspan="${daysInMonth + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                }

                html += '<tr>';
                html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                    <div class="agent-name">${fullName}</div>
                    ${agentInfo ? getAgentBadges(agentInfo) : ''}
                </td>`;

                // Afficher les statuts pour chaque jour
                for (let d = 0; d < daysInMonth; d++) {
                    const date = new Date(year, parseInt(month) - 1, d + 1);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(year, parseInt(month), d + 1);

                    let status = agent.days[d] || '';

                    // Ne mettre "Pr√©sent" que si c'est un jour ouvr√© et qu'il n'y a pas de statut
                    if (!status && !isWeekend && !isFerie) {
                        status = 'Pr√©sent';
                    }

                    let cellClass = 'day-cell';
                    let cellStyle = '';
                    let cellContent = status;

                    if (isWeekend || isFerie) {
                        cellClass += ' weekend';
                        if (isFerie) {
                            cellStyle = 'background: #ff9800; color: white;';
                        } else if (isWeekend) {
                            cellStyle = 'background: #e74c3c44;';
                        }
                    } else if (status === 'P') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `P<br>${getAgentBadges(agentInfo)}`;
                        }
                    } else if (status === 'PC') {
                        cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                    } else if (status === 'F') {
                        cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                    } else if (status === 'AST') {
                        cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                    } else if (status === 'CA') {
                        cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                    } else if (status === 'RTT') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'CEX') {
                        cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                    } else if (status === 'R') {
                        cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                    } else if (status === 'M') {
                        cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                    } else if (status === 'AT') {
                        cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                    } else if (status === 'TAD') {
                        cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                    } else if (status === 'TP') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'MA') {
                        cellStyle = 'background: #1abc9c; color: white; font-weight: bold;';
                    } else if (status === 'Pr√©sent') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                        }
                    }

                    html += `<td class="${cellClass}" style="${cellStyle}" data-status="${status}">${cellContent}</td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
        }

        function displayEmptyPlanning(period) {
            let html = '<table><thead><tr>';
            html += '<th style="min-width: 150px;">Agent</th>';

            // G√©n√©rer les en-t√™tes de colonnes selon la vue
            const columns = getColumnsForPeriod(period);
            columns.forEach(col => {
                html += `<th>${col.label}</th>`;
            });
            html += '</tr></thead><tbody>';

            // G√©n√©rer les lignes d'agents
            allAgents.forEach(agent => {
                html += '<tr>';
                html += `<td class="agent-cell">
                        <div class="agent-name">${agent.fullName}</div>
                        ${getAgentBadges(agent)}
                    </td>`;

                // Cellules vides pour chaque colonne
                columns.forEach(col => {
                    const isWeekend = col.isWeekend || false;
                    html += `<td class="day-cell ${isWeekend ? 'weekend' : ''}" 
                                    data-agent="${agent.index}" 
                                    data-date="${col.date || ''}"></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
        }

        async function displayAnnualView(year) {
            // R√©cup√©rer les donn√©es pour tous les mois de l'ann√©e
            const allMonthsData = [];
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            for (let m = 1; m <= 12; m++) {
                try {
                    const response = await fetch(`/api/planning-data/${year}/${String(m).padStart(2, '0')}`);
                    const data = await response.json();
                    if (data.success) {
                        allMonthsData.push({
                            month: m,
                            monthName: monthNames[m - 1],
                            agents: data.agents,
                            daysInMonth: new Date(year, m, 0).getDate()
                        });
                    }
                } catch (error) {
                    console.error(`Erreur mois ${m}:`, error);
                }
            }

            if (allMonthsData.length === 0) {
                planningTable.innerHTML = '<div class="loading">Aucune donn√©e</div>';
                return;
            }

            // Enrichir et trier les agents (prendre le premier mois avec donn√©es)
            const firstMonthAgents = allMonthsData[0]?.agents || [];
            const enrichedAgents = firstMonthAgents.map(agent => {
                const nom = agent.nom.toUpperCase().trim();
                let groupe = 'default';
                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }
                return { ...agent, groupe };
            });

            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            enrichedAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            // Cr√©er une section par mois avec TOUS les jours
            let html = '';

            allMonthsData.forEach(monthData => {
                html += `<h3 style="margin: 20px 0 10px 0; padding: 10px; background: #3498db; color: white;">${monthData.monthName} ${year}</h3>`;
                html += '<table><thead><tr>';
                html += '<th style="min-width: 150px;">Agent</th>';

                // En-t√™tes des jours du mois
                for (let d = 1; d <= monthData.daysInMonth; d++) {
                    const date = new Date(year, monthData.month - 1, d);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(year, monthData.month, d);
                    let bgColor = '';
                    if (isFerie) bgColor = '#e67e22';
                    else if (isWeekend) bgColor = '#e74c3c';
                    html += `<th style="${bgColor ? 'background: ' + bgColor + ';' : ''}">${d}</th>`;
                }
                html += '</tr></thead><tbody>';

                // Lignes des agents avec leurs statuts pour ce mois
                let currentGroup = '';
                enrichedAgents.forEach(agent => {
                    const fullName = `${agent.nom} ${agent.prenom}`;
                    const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const colors = groupColors[agent.groupe] || groupColors.default;

                    // Ligne s√©parateur de groupe
                    if (currentGroup !== agent.groupe) {
                        currentGroup = agent.groupe;
                        html += `<tr><td colspan="${monthData.daysInMonth + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                    }

                    // Trouver les donn√©es de cet agent pour ce mois
                    const agentMonth = monthData.agents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const days = agentMonth ? agentMonth.days : [];

                    html += '<tr>';
                    html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                        <div class="agent-name">${fullName}</div>
                        ${agentInfo ? getAgentBadges(agentInfo) : ''}
                    </td>`;

                    // Afficher chaque jour
                    for (let d = 1; d <= monthData.daysInMonth; d++) {
                        const date = new Date(year, monthData.month - 1, d);
                        const dayOfWeek = date.getDay();
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isFerie = isJourFerie(year, monthData.month, d);

                        const status = days[d - 1] || '';
                        let cellContent = status;
                        let cellStyle = '';

                        // Si pas de statut et que c'est un jour travaill√©
                        if (!status && !isWeekend && !isFerie) {
                            cellContent = 'Pr√©sent';
                            cellStyle = 'background: #00ff00; color: black;';
                            if (agentInfo) {
                                cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                            }
                        } else if (status === 'P') {
                            cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        } else if (status === 'PC') {
                            cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                        } else if (status === 'F') {
                            cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                        } else if (status === 'AST') {
                            cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                        } else if (status === 'CA') {
                            cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                        } else if (status === 'RTT') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (status === 'CEX') {
                            cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                        } else if (status === 'R') {
                            cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                        } else if (status === 'M') {
                            cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                        } else if (status === 'AT') {
                            cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                        } else if (status === 'TAD') {
                            cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                        } else if (status === 'TP') {
                            cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                        } else if (status === 'MA') {
                            cellStyle = 'background: #1abc9c; color: white; font-weight: bold;';
                        } else if (isWeekend) {
                            cellStyle = 'background: #e74c3c44;';
                        } else if (isFerie) {
                            cellStyle = 'background: #e67e2244;';
                        }

                        html += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    html += '</tr>';
                });

                html += '</tbody></table>';
            });

            planningTable.innerHTML = html;
        }

        function getMonthSummary(days) {
            const counts = { PC: 0, M: 0, Present: 0 };
            days.forEach(d => {
                if (d === 'PC') counts.PC++;
                else if (d === 'M') counts.M++;
                else if (d) counts.Present++;
            });
            return `P:${counts.Present} C:${counts.PC} M:${counts.M}`;
        }

        async function displayQuarterView(quarter) {
            // Q1-2026 -> mois 1,2,3
            const quarterMap = {
                'Q1-2026': [1, 2, 3],
                'Q2-2026': [4, 5, 6],
                'Q3-2026': [7, 8, 9],
                'Q4-2026': [10, 11, 12]
            };
            const months = quarterMap[quarter] || [1, 2, 3];

            // R√©cup√©rer donn√©es des 3 mois
            const allDaysData = [];
            for (const m of months) {
                try {
                    const response = await fetch(`/api/planning-data/2026/${String(m).padStart(2, '0')}`);
                    const data = await response.json();
                    if (data.success) {
                        const daysInMonth = new Date(2026, m, 0).getDate();
                        for (let d = 1; d <= daysInMonth; d++) {
                            allDaysData.push({
                                month: m,
                                day: d,
                                agents: data.agents
                            });
                        }
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            // Construire planning trimestriel (afficher tous les jours)
            displayMultiMonthPlanning(allDaysData, 'trimestriel');
        }

        async function displayBiweeklyView(period) {
            // Format: 2026-W1 = semaine 1 de 2026
            const year = 2026;
            const weekNum = parseInt(period.split('-W')[1]);

            // Calculer les dates (14 jours)
            const startDate = new Date(2026, 0, 1 + (weekNum - 1) * 14);
            const allDaysData = [];

            for (let i = 0; i < 14; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const month = currentDate.getMonth() + 1;
                const day = currentDate.getDate();

                try {
                    const response = await fetch(`/api/planning-data/${year}/${String(month).padStart(2, '0')}`);
                    const data = await response.json();
                    if (data.success) {
                        allDaysData.push({
                            month,
                            day,
                            date: currentDate,
                            agents: data.agents
                        });
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            displayMultiMonthPlanning(allDaysData, 'bihebdo');
        }

        function displayMultiMonthPlanning(allDaysData, viewType) {
            if (allDaysData.length === 0) {
                planningTable.innerHTML = '<div class="loading">Aucune donn√©e</div>';
                return;
            }

            // Enrichir et trier les agents
            const firstDay = allDaysData[0];
            const enrichedAgents = firstDay.agents.map(agent => {
                const nom = agent.nom.toUpperCase().trim(); // TRIM pour g√©rer les espaces
                let groupe = 'default';
                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {
                        groupe = groupeName;
                        break;
                    }
                }
                return { ...agent, groupe };
            });

            const groupOrder = ['Encadrant', 'Surveillant de travaux', 'Encadrant Propret√©', 'Agents Voirie', 'Agent EV', 'COMMUN - Magasinier', 'default'];
            enrichedAgents.sort((a, b) => {
                const indexA = groupOrder.indexOf(a.groupe);
                const indexB = groupOrder.indexOf(b.groupe);
                return indexA - indexB;
            });

            let html = '<table><thead><tr>';
            html += '<th style="min-width: 150px;">Agent</th>';

            // En-t√™tes des jours
            allDaysData.forEach(dayData => {
                const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isFerie = isJourFerie(2026, dayData.month, dayData.day);
                html += `<th style="${isWeekend || isFerie ? 'background: ' + (isFerie ? '#ff9800' : '#e74c3c') : ''}">${dayData.day}/${dayData.month}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Lignes des agents
            let currentGroup = '';
            enrichedAgents.forEach(agent => {
                const fullName = `${agent.nom} ${agent.prenom}`;
                const agentInfo = allAgents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                const colors = groupColors[agent.groupe] || groupColors.default;

                if (currentGroup !== agent.groupe) {
                    currentGroup = agent.groupe;
                    html += `<tr><td colspan="${allDaysData.length + 1}" style="background: ${colors.bg}; color: white; font-weight: bold; text-align: center; padding: 10px;">${agent.groupe}</td></tr>`;
                }

                html += '<tr>';
                html += `<td class="agent-cell" style="background: ${colors.bg}33; border-left: 3px solid ${colors.border};">
                    <div class="agent-name">${fullName}</div>
                    ${agentInfo ? getAgentBadges(agentInfo) : ''}
                </td>`;

                // Afficher le statut pour chaque jour
                allDaysData.forEach(dayData => {
                    const agentDay = dayData.agents.find(a => a.nom === agent.nom && a.prenom === agent.prenom);
                    const dayIndex = dayData.day - 1;

                    const date = dayData.date || new Date(2026, dayData.month - 1, dayData.day);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isFerie = isJourFerie(2026, dayData.month, dayData.day);

                    let status = agentDay ? agentDay.days[dayIndex] : '';
                    let cellContent = status;

                    if (!status && !isWeekend && !isFerie) {
                        status = 'Pr√©sent';
                        cellContent = 'Pr√©sent';
                        // Ajouter les badges si l'agent est pr√©sent
                        if (agentInfo) {
                            cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                        }
                    }

                    let cellClass = 'day-cell';
                    let cellStyle = '';
                    if (isWeekend || isFerie) {
                        cellClass += ' weekend';
                        if (isFerie) {
                            cellStyle = 'background: #ff9800; color: white;';
                        }
                    } else if (status === 'P') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `P<br>${getAgentBadges(agentInfo)}`;
                        }
                    } else if (status === 'PC') {
                        cellStyle = 'background: #ff00ff; color: white; font-weight: bold;';
                    } else if (status === 'F') {
                        cellStyle = 'background: #8000ff; color: white; font-weight: bold;';
                    } else if (status === 'AST') {
                        cellStyle = 'background: #0000ff; color: white; font-weight: bold;';
                    } else if (status === 'CA') {
                        cellStyle = 'background: #ffff00; color: black; font-weight: bold;';
                    } else if (status === 'RTT') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'CEX') {
                        cellStyle = 'background: #00ffff; color: black; font-weight: bold;';
                    } else if (status === 'R') {
                        cellStyle = 'background: #ff0000; color: white; font-weight: bold;';
                    } else if (status === 'M') {
                        cellStyle = 'background: #ff8000; color: white; font-weight: bold;';
                    } else if (status === 'AT') {
                        cellStyle = 'background: #ff4000; color: white; font-weight: bold;';
                    } else if (status === 'TAD') {
                        cellStyle = 'background: #0080ff; color: white; font-weight: bold;';
                    } else if (status === 'TP') {
                        cellStyle = 'background: #ffff80; color: black; font-weight: bold;';
                    } else if (status === 'MA') {
                        cellStyle = 'background: #1abc9c; color: white; font-weight: bold;';
                    } else if (status === 'Pr√©sent') {
                        cellStyle = 'background: #00ff00; color: black; font-weight: bold;';
                        if (agentInfo) {
                            cellContent = `Pr√©sent<br>${getAgentBadges(agentInfo)}`;
                        }
                    }

                    html += `<td class="${cellClass}" style="${cellStyle}">${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
        }

        function getAgentBadges(agent) {
            const badges = [];
            const seen = new Set();

            agent.aptitudes.forEach(apt => {
                const nomLower = apt.nom ? apt.nom.toLowerCase() : '';

                // Filtrer anniversaire et visites
                if (nomLower.includes('anniversaire') || nomLower.includes('visite') ||
                    nomLower.includes('derni√®re') || nomLower.includes('prochaine') ||
                    nomLower.includes('derniere')) {
                    return;
                }

                let badgeClass = '';
                let badgeText = '';
                const val = apt.valeur ? String(apt.valeur) : '';

                // Correspondances plus larges : utiliser le nom de l'en-t√™te (header) pour d√©cider
                if (nomLower.includes('r.482') || nomLower.includes('r482') || nomLower.includes('caces')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('grue') || nomLower.includes('nacelle') || nomLower.includes('r.490') || nomLower.includes('nacelle')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('chariot') || nomLower.includes('r.489')) {
                    badgeClass = 'badge-caces';
                    badgeText = 'C';
                } else if (nomLower.includes('tondeuse')) {
                    badgeClass = 'badge-tondeuse';
                    badgeText = 'Tn';
                } else if (nomLower.includes('tron√ßo') || nomLower.includes('tronco')) {
                    badgeClass = 'badge-tronco';
                    badgeText = 'T';
                } else if (nomLower.includes('permis') || nomLower.includes('remorque') || nomLower.includes('perm')) {
                    badgeClass = 'badge-permis';
                    badgeText = 'P';
                } else if (nomLower.includes('aipr')) {
                    badgeClass = 'badge-aipr';
                    badgeText = 'A';
                } else if (nomLower.includes('fimo')) {
                    badgeClass = 'badge-fimo';
                    badgeText = 'F';
                } else if (nomLower.includes('secours') || nomLower.includes('premiers secours')) {
                    badgeClass = 'badge-secours';
                    badgeText = 'S';
                } else {
                    // Si l'en-t√™te n'est pas reconnu mais la valeur est pr√©sente, cr√©er une pastille g√©n√©rique
                    if (val && val !== '‚úì') {
                        badgeClass = 'badge-generic';
                        // texte court bas√© sur le header (2-3 chars)
                        const words = nomLower.split(/\s+/);
                        badgeText = (words[0] || '').substring(0, 3).toUpperCase();
                    }
                }

                if (badgeClass && badgeText && !seen.has(badgeText)) {
                    const title = val && val !== '‚úì' ? `${apt.nom}: ${val}` : apt.nom;
                    badges.push({ class: badgeClass, text: badgeText, title });
                    seen.add(badgeText);
                }
            });

            if (badges.length === 0) return '';

            return '<div class="agent-badges">' +
                badges.map(b => `<span class="badge-mini ${b.class}" title="${b.title}">${b.text}</span>`).join('') +
                '</div>';
        }

        function getColumnsForPeriod(period) {
            if (currentView === 'annuel') {
                // 12 mois de l'ann√©e
                const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jui', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
                return months.map((m, idx) => ({
                    label: m,
                    date: `${period}-${String(idx + 1).padStart(2, '0')}`
                }));
            } else if (currentView === 'trimestriel') {
                // 3 mois avec environ 13 semaines chacun
                const columns = [];
                const quarterMonths = {
                    'Q1-2026': ['Janvier', 'F√©vrier', 'Mars'],
                    'Q2-2026': ['Avril', 'Mai', 'Juin'],
                    'Q3-2026': ['Juillet', 'Ao√ªt', 'Septembre'],
                    'Q4-2026': ['Octobre', 'Novembre', 'D√©cembre']
                };

                const months = quarterMonths[period] || ['Jan', 'F√©v', 'Mar'];
                months.forEach(month => {
                    // 4-5 semaines par mois
                    for (let w = 1; w <= 4; w++) {
                        columns.push({
                            label: `${month.substring(0, 3)} S${w}`,
                            date: `${month}-W${w}`
                        });
                    }
                });
                return columns;
            } else if (currentView === 'mensuel') {
                // Tous les jours du mois
                const [year, month] = period.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                const columns = [];

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, parseInt(month) - 1, d);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    columns.push({
                        label: d.toString(),
                        date: `${year}-${month}-${String(d).padStart(2, '0')}`,
                        isWeekend
                    });
                }
                return columns;
            } else if (currentView === 'bihebdo') {
                // 14 jours (2 semaines)
                const columns = [];
                const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

                for (let d = 0; d < 14; d++) {
                    const dayOfWeek = d % 7;
                    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                    const weekNum = Math.floor(d / 7) + 1;

                    columns.push({
                        label: `S${weekNum} ${dayNames[dayOfWeek]}`,
                        date: `W${weekNum}-D${d + 1}`,
                        isWeekend
                    });
                }
                return columns;
            }
            return [];
        }

        function filterByGroup() {
            selectedGroup = document.getElementById('groupFilter').value;

            // Re-afficher le planning avec le filtre
            if (currentPlanningData) {
                displayMonthlyPlanning(currentPlanningData.agents.map(a => ({
                    nom: a.nom,
                    prenom: a.prenom,
                    matricule: a.matricule,
                    days: a.days
                })), currentPlanningData.year, currentPlanningData.month);
            }
        }

        // Gestion de l'orientation d'impression
        document.getElementById('printOrientation').addEventListener('change', function () {
            document.body.classList.remove('landscape-print', 'portrait-print');
            document.body.classList.add(this.value + '-print');
        });

        // Modal de g√©n√©ration
        function showGenerateModal() {
            document.getElementById('generateModal').style.display = 'block';
        }

        function closeGenerateModal() {
            document.getElementById('generateModal').style.display = 'none';
        }

        async function generatePlanningFromModal() {
            const week = document.getElementById('generateWeek').value;
            const teamSize = document.getElementById('teamSize').value;

            if (!week) {
                alert('Veuillez s√©lectionner une semaine');
                return;
            }

            closeGenerateModal();
            planningTable.innerHTML = '<div class="loading">G√©n√©ration du planning...</div>';

            try {
                const response = await fetch('/api/generate-teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week, teamSize })
                });

                if (response.headers.get('content-type')?.includes('spreadsheet')) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `planning_semaine_${week}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    planningTable.innerHTML = '<div class="loading">‚úÖ Planning g√©n√©r√© et t√©l√©charg√© !</div>';
                } else {
                    const data = await response.json();
                    planningTable.innerHTML = `<div class="loading">‚ùå ${data.error || 'Erreur'}</div>`;
                }
            } catch (error) {
                planningTable.innerHTML = `<div class="loading">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Fermer modal au clic ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('generateModal');
            if (event.target === modal) {
                closeGenerateModal();
            }
        }

        // Fonction pour charger un planning Excel
        async function loadExcelPlanning(event) {
            const file = event.target.files[0];
            if (!file) return;

            planningTable.innerHTML = '<div class="loading">Chargement du fichier Excel...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/load-planning', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayUploadedPlanning(data);
                } else {
                    planningTable.innerHTML = `<div class="loading">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                planningTable.innerHTML = `<div class="loading">‚ùå Erreur: ${error.message}</div>`;
            }

            // R√©initialiser l'input
            event.target.value = '';
        }

        function displayUploadedPlanning(data) {
            // Afficher les donn√©es du planning upload√©
            let html = `<h3 style="margin: 0 0 20px 0; padding: 10px; background: #3498db; color: white;">${data.title || 'Planning charg√©'}</h3>`;
            html += '<table><thead><tr>';

            // En-t√™tes
            data.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Lignes de donn√©es
            data.rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, idx) => {
                    const cellValue = cell || '';
                    let cellStyle = '';

                    // Coloration selon contenu (optionnel)
                    if (idx === 0) {
                        cellStyle = 'font-weight: bold; background: #f8f9fa;';
                    }

                    html += `<td style="${cellStyle}">${cellValue}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            planningTable.innerHTML = html;
        }

        // Charger les agents au d√©marrage
        loadAgents().then(() => {
            updatePeriodSelector();
        });
    </script>
</body>

</html>