<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Planning - ST88</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            color: #1a1a2e;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #8B1538 0%, #6B0F2A 50%, #4A0A1C 100%);
            padding: 0;
            border-bottom: 4px solid #FFB81C;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            margin: 0 0 20px;
            box-shadow: 0 8px 32px rgba(139, 21, 56, 0.4);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -80px;
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, rgba(0, 168, 89, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -60px;
            left: -90px;
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, rgba(255, 184, 28, 0.12) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px 40px;
            position: relative;
            z-index: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #8B1538, #00A859);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            color: white;
            border: 3px solid #FFB81C;
            box-shadow: 0 4px 12px rgba(139, 21, 56, 0.3);
        }

        .header-kicker {
            font-size: 11px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.65);
            margin: 0;
        }

        h1 {
            color: #fff;
            margin: 0;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        h1::before {
            content: '';
            margin-right: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-search {
            width: min(260px, 40vw);
        }

        .header-search input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .header-search input::placeholder {
            color: rgba(255, 255, 255, 0.65);
        }

        .header-cta {
            border: none;
            border-radius: 999px;
            padding: 12px 22px;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            cursor: pointer;
            background: linear-gradient(135deg, #FFB81C 0%, #FFA500 100%);
            color: #8B1538;
            box-shadow: 0 8px 20px rgba(255, 184, 28, 0.5);
            transition: all 0.3s ease;
        }

        .header-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(255, 184, 28, 0.6);
        }

        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 40px;
            flex-wrap: wrap;
            gap: 14px;
            z-index: 1;
        }

        nav {
            display: flex;
            gap: 4px;
            margin: 0;
            background: transparent;
            padding: 0 40px 20px;
            position: relative;
            z-index: 1;
        }

        nav a {
            padding: 10px 20px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 24px;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.2s ease;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        nav a:hover {
            background: rgba(0, 168, 89, 0.25);
            color: #fff;
        }

        nav a.active {
            color: #fff;
            background: rgba(255, 184, 28, 0.2);
            box-shadow: 0 0 16px rgba(255, 184, 28, 0.6);
        }

        .header-bottom .header-bottom-actions {
            margin-left: auto;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .echeances-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
            transition: all 0.3s ease;
        }

        .echeances-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .echeances-counter {
            padding: 2px 9px;
            border-radius: 12px;
            background: #FFB81C;
            color: #8B1538;
            font-size: 11px;
            font-weight: 800;
        }

        .stats-meta {
            font-size: 11px;
            letter-spacing: 0.4px;
            color: rgba(255, 255, 255, 0.75);
        }

        .generator-box {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 0 0 20px 20px;
            padding: 45px 50px;
            margin: 0;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-top: none;
        }

        .generator-box h2 {
            background: linear-gradient(135deg, #ee7752 0%, #e73c7e 50%, #23a6d5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            margin-bottom: 32px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e8;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            color: #333;
            font-weight: 500;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .generator-box button {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            background: #4a90e2;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .generator-box button:hover {
            background: #357abd;
        }

        .generator-box button:active {
            background: #2a5a8f;
        }

        .info-box {
            background: #f8f9fb;
            border: 1px solid #e0e0e8;
            border-left: 4px solid #4a90e2;
            padding: 16px 18px;
            border-radius: 6px;
            margin-top: 24px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
            font-size: 13px;
            font-weight: 500;
        }

        .info-box strong {
            color: #4a90e2;
            font-weight: 700;
        }

        .progress-container {
            display: none;
            margin-top: 32px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 240, 255, 0.9) 100%);
            border-radius: 14px;
            padding: 28px 32px;
            box-shadow: 0 20px 60px rgba(231, 60, 126, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(238, 119, 82, 0.1);
            backdrop-filter: blur(30px);
            animation: slideUp 0.6s ease-out 0.3s both;
        }

        .progress-container.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: linear-gradient(90deg, rgba(238, 119, 82, 0.1) 0%, rgba(35, 213, 171, 0.1) 100%);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ee7752 0%, #e73c7e 50%, #23a6d5 100%);
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 900;
            font-size: 11px;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(231, 60, 126, 0.4);
            animation: gradient-shine 2s ease-in-out infinite;
        }

        @keyframes gradient-shine {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(231, 60, 126, 0.4);
            }

            50% {
                box-shadow: 0 0 30px rgba(35, 165, 213, 0.6);
            }
        }

        .progress-text {
            margin-top: 16px;
            text-align: center;
            background: linear-gradient(135deg, #ee7752 0%, #e73c7e 50%, #23a6d5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        body.modal-open {
            overflow: hidden;
        }

        .echeances-modal {
            position: fixed;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(10, 14, 30, 0.85);
            padding: 24px 16px;
            z-index: 1100;
        }

        .echeances-modal.visible {
            display: flex;
        }

        .echeances-panel {
            width: min(760px, 100%);
            background: #0f1b38;
            border-radius: 24px;
            padding: 24px 28px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.55);
            position: relative;
        }

        .echeances-panel h2 {
            margin-bottom: 4px;
            color: #f8fafc;
            font-size: 22px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        .modal-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
        }

        .echeances-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .echeances-column {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 16px;
            min-height: 220px;
        }

        .echeances-column h3 {
            font-size: 14px;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            color: #9cb4d6;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .echeances-list {
            max-height: 220px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
            color: #f0f4ff;
        }

        .echeance-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .echeance-agent {
            font-weight: 700;
            display: block;
            color: #fff;
        }

        .echeance-aptitude {
            opacity: 0.85;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.75);
        }

        .echeance-date {
            font-weight: 700;
            color: #ffd166;
            font-size: 12px;
            white-space: nowrap;
        }

        .empty-state {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
        }

        .modal-close {
            position: absolute;
            top: 14px;
            right: 14px;
            background: rgba(255, 255, 255, 0.12);
            border: none;
            color: #fff;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">

        <header>
            <div class="header-top">
                <div class="header-logo">
                    <div class="header-logo-icon"></div>
                    <div>
                        <p class="header-kicker">Service Technique 88</p>
                        <h1>G√©n√©rateur de Planning</h1>
                    </div>
                </div>
            </div>
            <nav>
                <a href="/">Agents</a>
                <a href="/planning">Planning</a>
                <a href="/generator" class="active">G√©n√©rateur</a>
            </nav>
        </header>

        <div class="generator-box">
            <h2>Configuration</h2>


            <div class="form-group">
                <label>üóìÔ∏è Semaine</label>
                <input type="week" id="weekInput">
            </div>

            <div class="form-group">
                <label>üë• Groupe</label>
                <select id="groupSelect">
                    <option value="all">Tous</option>
                    <option value="Encadrant">Encadrant</option>
                    <option value="Surveillant de travaux">Surveillant de travaux</option>
                    <option value="Encadrant Propret√©">Encadrant Propret√©</option>
                    <option value="Agents Voirie">Agents Voirie</option>
                    <option value="Agent EV">Agent EV</option>
                    <option value="COMMUN - Magasinier">COMMUN - Magasinier</option>
                </select>
            </div>

            <div class="form-group">
                <label>üî¢ Agents par √©quipe</label>
                <select id="teamSizeInput">
                    <option value="3">3 agents par √©quipe</option>
                    <option value="2">2 agents par √©quipe</option>
                </select>
            </div>

            <button onclick="generateTeams()">‚ú® G√©n√©rer les √©quipes</button>

            <div id="progressContainer" class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
                </div>
                <div id="progressText" class="progress-text">Pr√©paration...</div>
            </div>

            <div class="info-box">
                <p><strong>‚ÑπÔ∏è Comment √ßa marche</strong></p>
                <p style="margin-top: 8px;">G√©n√©rez automatiquement des √©quipes intelligentes :</p>
                <ul style="margin-top: 10px; margin-left: 20px; color: #555; font-size: 13px;">
                    <li>R√©partition √©quitable des agents</li>
                    <li>√âquipes de 2 ou 3 agents</li>
                    <li>Gestion des comp√©tences</li>
                    <li>Export Excel instantan√©</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="echeancesModal" class="echeances-modal" role="dialog" aria-modal="true" aria-labelledby="echeancesTitle">
        <div class="echeances-panel">
            <button class="modal-close" type="button" aria-label="Fermer" onclick="closeEcheancesModal()">√ó</button>
            <h2 id="echeancesTitle">√âch√©ances &agrave; surveiller</h2>
            <p class="modal-subtitle">Pr√©parez vos √©quipes et habilitations sur les trois prochains mois.</p>
            <div class="echeances-columns">
                <div class="echeances-column">
                    <h3>3 mois <span id="modalCount3m">0</span></h3>
                    <div id="modalList3m" class="echeances-list"></div>
                </div>
                <div class="echeances-column">
                    <h3>12 mois <span id="modalCount1an">0</span></h3>
                    <div id="modalList1an" class="echeances-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function generateTeams() {
            const week = document.getElementById('weekInput').value;
            const group = document.getElementById('groupSelect').value;
            const teamSize = parseInt(document.getElementById('teamSizeInput').value);

            if (!week) {
                alert('‚ö†Ô∏è S√©lectionnez une semaine');
                return;
            }

            // Afficher la barre de progression
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.classList.add('active');
            progressFill.style.width = '10%';
            progressFill.textContent = '10%';
            progressText.textContent = 'R√©cup√©ration des donn√©es...';

            try {
                // Simuler les √©tapes
                setTimeout(() => {
                    progressFill.style.width = '30%';
                    progressFill.textContent = '30%';
                    progressText.textContent = 'Analyse des disponibilit√©s...';
                }, 200);

                setTimeout(() => {
                    progressFill.style.width = '60%';
                    progressFill.textContent = '60%';
                    progressText.textContent = 'R√©partition des √©quipes...';
                }, 500);

                setTimeout(() => {
                    progressFill.style.width = '80%';
                    progressFill.textContent = '80%';
                    progressText.textContent = 'G√©n√©ration du fichier Excel...';
                }, 800);
                const response = await fetch('/api/generate-teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week, group, team_size: teamSize })
                });

                progressFill.style.width = '95%';
                progressFill.textContent = '95%';
                progressText.textContent = 'Finalisation...';

                // V√©rifier si c'est un fichier Excel (t√©l√©chargement)
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('spreadsheet')) {
                    // T√©l√©charger le fichier
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `planning_semaine_${week}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    progressFill.style.width = '100%';
                    progressFill.textContent = '100%';
                    progressText.textContent = '‚úÖ Planning t√©l√©charg√© avec succ√®s!';

                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                        progressFill.style.width = '0%';
                    }, 3000);

                    alert(`‚úÖ Planning t√©l√©charg√© avec succ√®s!\nFichier: planning_semaine_${week}.xlsx`);
                    return;
                }

                // Sinon traiter comme JSON (erreur)
                const data = await response.json();
                if (!data.success) {
                    progressText.textContent = '‚ùå Erreur: ' + data.error;
                    progressFill.style.background = '#e74c3c';
                    alert('Erreur: ' + data.error);
                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                        progressFill.style.width = '0%';
                        progressFill.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }, 3000);
                    return;
                }
            } catch (e) {
                progressText.textContent = '‚ùå Erreur: ' + e.message;
                progressFill.style.background = '#e74c3c';
                alert('Erreur: ' + e.message);
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    progressFill.style.width = '0%';
                    progressFill.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 3000);
            }
        }

        // Afficher le r√©sultat de la g√©n√©ration
        function renderResult(result) {
            const containerId = 'resultBox';
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                container.style.marginTop = '20px';
                document.querySelector('.generator-box').appendChild(container);
            }
            // Construire un tableau
            const assignments = result.assignments || {};
            let html = '<h3 style="margin-top:10px;color:#2c3e50;">R√©sultat g√©n√©ration</h3>';
            html += '<table style="width:100%; border-collapse: collapse; margin-top:10px;">';
            html += '<thead><tr><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd">Date</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd">Assignations</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ddd">Disponibles</th></tr></thead>';
            html += '<tbody>';
            for (const day of Object.keys(assignments)) {
                const info = assignments[day];
                const assigned = info.assigned || [];
                const available = info.available || [];
                html += `<tr><td style="padding:8px; border-bottom:1px solid #eee">${day}</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #eee">${assigned.map(a => a.fullName).join(', ')}</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #eee">${available.map(a => a.fullName).join(', ')}</td>`;
                html += '</tr>';
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function generateWeek() {
            const week = document.getElementById('weekInput').value;
            const group = document.getElementById('groupSelect').value;
            const slots = parseInt(document.getElementById('slotsInput').value || '1', 10);

            if (!week) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une semaine (YYYY-Www)');
                return;
            }

            // Format attendu: YYYY-Www (HTML input week)
            try {
                const response = await fetch('/api/generate-week', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week, group, slots })
                });
                const data = await response.json();
                if (!data.success) {
                    alert('Erreur g√©n√©ration: ' + data.error);
                    return;
                }
                renderResult(data);
                // ajouter bouton d'application
                let applyBtn = document.getElementById('applyBtn');
                if (!applyBtn) {
                    applyBtn = document.createElement('button');
                    applyBtn.id = 'applyBtn';
                    applyBtn.textContent = 'üíæ Appliquer au planning (√©crire dans Excel)';
                    applyBtn.style.marginTop = '12px';
                    applyBtn.onclick = applyWeek;
                    document.querySelector('.generator-box').appendChild(applyBtn);
                }
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function applyWeek() {
            const week = document.getElementById('weekInput').value;
            const group = document.getElementById('groupSelect').value;
            const slots = parseInt(document.getElementById('slotsInput').value || '1', 10);
            if (!week) {
                alert('S√©lectionnez une semaine d\'abord'); return;
            }
            if (!confirm('‚ö†Ô∏è Confirmez-vous l\'√©criture dans le fichier Excel ? Une sauvegarde sera cr√©√©e automatiquement.')) return;

            try {
                const resp = await fetch('/api/apply-week', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week, group, slots })
                });
                const data = await resp.json();
                if (!data.success) return alert('Erreur: ' + data.error);
                alert('‚úÖ Application termin√©e ‚Äî ' + (data.written || 0) + ' cellules √©crites. Sauvegarde: ' + (data.backup || 'n/a'));
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function reloadExcel() {
            const status = document.getElementById('reloadStatus');
            status.textContent = 'Chargement...';
            try {
                const resp = await fetch('/api/reload-excel', { method: 'POST' });
                const data = await resp.json();
                if (!data.success) {
                    status.textContent = 'Erreur: ' + data.error;
                    return;
                }
                const date = new Date(data.mtime * 1000).toLocaleString('fr-FR');
                status.textContent = `OK ‚Äî ${data.sheets.length} feuilles ‚Äî modifi√©: ${date}`;
                await loadAgents();
                updateStats();
            } catch (e) {
                status.textContent = 'Erreur: ' + e.message;
            }
        }

        let allAgents = [];
        const groupes = {
            'Encadrant': ['DEBREYNE', 'LUTARD', 'HAUTDECOEUR', 'GRENET', 'FOURCADE', 'GONCALVES', 'SIGALA', 'BETTINGER', 'TUCOULET', 'VRBOVSKA'],
            'Surveillant de travaux': ['BOURGOIN', 'MERCADIEU', 'GARCIA', 'LARROUDE', 'SAMITIER', 'PIEL'],
            'Encadrant Propret√©': ['GOURVIAT', 'LARTIGUE', 'TRIQUENEAUX', 'ESPERON', 'ROUGLAN', 'NOURRI'],
            'Agents Voirie': ['BERRIO-GAUDNER', 'FONTENEAU', 'GUIJARRO', 'GOUREAU', 'LABORIE', 'LARRIEU', 'LEVIGNAT', 'MARTIN-HERNANDEZ', 'PIERRE', 'SOLA', 'WEISS'],
            'Agent EV': ['DELANDE', 'DA SILVA REIS', 'ELMAGROUD', 'ESTEVE', 'KADRI', 'MALLET', 'MAURY', 'MOINGT', 'REY', 'TADJROUNA', 'VILLENEUVE'],
            'COMMUN - Magasinier': ['VOL', 'GENNA', 'BERNARD', 'HAUBRAICHE']
        };

        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();

                if (data.success) {
                    allAgents = data.agents.map((agent, index) => {
                        const aptitudes = [];
                        agent.data.forEach((val, idx) => {
                            const header = data.headers[idx];
                            if (header && idx >= 7) {
                                if (val !== null && val !== undefined && String(val).trim() !== '') {
                                    let dateObj = null;
                                    let display = '';

                                    const parsed = new Date(val);
                                    if (!isNaN(parsed.getTime())) {
                                        dateObj = parsed;
                                        try {
                                            display = parsed.toLocaleDateString('fr-FR');
                                        } catch (e) {
                                            display = String(val);
                                        }
                                    } else if (typeof val === 'string' && val.trim().toLowerCase() === 'x') {
                                        display = '‚úì';
                                    } else {
                                        display = String(val).trim();
                                    }

                                    aptitudes.push({
                                        nom: header,
                                        valeur: display,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        });

                        const nom = agent.nom.toUpperCase().trim();
                        let groupe = 'default';

                        for (const [groupeName, noms] of Object.entries(groupes)) {
                            if (noms.some(n => nom === n)) {
                                groupe = groupeName;
                                break;
                            }
                        }

                        return {
                            index,
                            matricule: agent.matricule,
                            nom: agent.nom,
                            prenom: agent.prenom,
                            fullName: `${agent.nom} ${agent.prenom}`,
                            aptitudes,
                            groupe
                        };
                    });
                }
            } catch (error) {
                console.error('Erreur chargement agents:', error);
            }
        }

        function updateStats() {
            const today = new Date();
            const threeMonthsLater = new Date();
            threeMonthsLater.setMonth(today.getMonth() + 3);
            const oneYearLater = new Date();
            oneYearLater.setFullYear(today.getFullYear() + 1);

            const expiring3Months = [];
            const expiring1Year = [];

            allAgents.forEach(agent => {
                agent.aptitudes.forEach(apt => {
                    if (apt.dateObj && apt.dateObj >= today) {
                        const expiration = {
                            agent: `${agent.nom} ${agent.prenom}`,
                            aptitude: apt.nom,
                            date: apt.valeur,
                            dateObj: apt.dateObj
                        };

                        if (apt.dateObj <= threeMonthsLater) {
                            expiring3Months.push(expiration);
                        } else if (apt.dateObj <= oneYearLater) {
                            expiring1Year.push(expiration);
                        }
                    }
                });
            });

            expiring3Months.sort((a, b) => a.dateObj - b.dateObj);
            expiring1Year.sort((a, b) => a.dateObj - b.dateObj);

            const totalEcheances = expiring3Months.length + expiring1Year.length;
            const echeancesBadge = document.getElementById('echeancesBadge');
            if (echeancesBadge) {
                echeancesBadge.textContent = totalEcheances;
            }

            const statsStamp = document.getElementById('statsUpdatedAt');
            if (statsStamp) {
                statsStamp.textContent = today.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            const renderList = (target, list, fallback) => {
                if (!target) return;
                if (!list.length) {
                    target.innerHTML = `<div class="empty-state">${fallback}</div>`;
                    return;
                }

                target.innerHTML = list.map(exp => `
                    <div class="echeance-item">
                        <div>
                            <span class="echeance-agent">${exp.agent}</span>
                            <span class="echeance-aptitude">${exp.aptitude}</span>
                        </div>
                        <span class="echeance-date">${exp.date}</span>
                    </div>
                `).join('');
            };

            const modalCount3m = document.getElementById('modalCount3m');
            const modalCount1an = document.getElementById('modalCount1an');
            const modalList3m = document.getElementById('modalList3m');
            const modalList1an = document.getElementById('modalList1an');

            if (modalCount3m) modalCount3m.textContent = expiring3Months.length;
            if (modalCount1an) modalCount1an.textContent = expiring1Year.length;

            renderList(modalList3m, expiring3Months, 'Aucune √©ch√©ance dans les 3 mois.');
            renderList(modalList1an, expiring1Year, 'Aucune √©ch√©ance r√©pertori√©e d‚Äôici 12 mois.');
        }

        function openEcheancesModal() {
            const modal = document.getElementById('echeancesModal');
            if (!modal) return;
            modal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeEcheancesModal() {
            const modal = document.getElementById('echeancesModal');
            if (!modal) return;
            modal.classList.remove('visible');
            document.body.classList.remove('modal-open');
        }

        const echeancesModal = document.getElementById('echeancesModal');
        if (echeancesModal) {
            echeancesModal.addEventListener('click', (ev) => {
                if (ev.target === echeancesModal) {
                    closeEcheancesModal();
                }
            });
        }

        document.addEventListener('keyup', (ev) => {
            if (ev.key === 'Escape') {
                closeEcheancesModal();
            }
        });

        loadAgents().then(() => updateStats());
    </script>
</body>

</html>