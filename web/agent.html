<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Agents</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        #fileInput {
            display: none;
        }

        .file-label {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .info {
            padding: 15px 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            color: #2e7d32;
            font-weight: 500;
            border-left: 4px solid #4caf50;
        }

        .search-box {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            width: 350px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card p {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .agent-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .agent-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .agent-matricule {
            font-size: 13px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }

        .agent-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .detail-label {
            color: #7f8c8d;
            font-weight: 600;
            min-width: 120px;
        }

        .detail-value {
            color: #2c3e50;
        }

        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge.danger {
            background: #ffebee;
            color: #c62828;
        }

        .agent-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .action-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .action-btn.edit:hover {
            background: #1976d2;
            color: white;
        }

        .action-btn.delete {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn.delete:hover {
            background: #c62828;
            color: white;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 8px;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stat-card p {
            font-size: 24px;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            font-size: 22px;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .modal-actions button {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üë• Gestion des Agents</h1>

            <div class="controls">
                <label for="fileInput" class="file-label">üìÅ Charger le fichier Excel</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <button id="btnSave" class="btn-success" style="display:none;">üíæ T√©l√©charger</button>
                <button id="btnAddAgent" class="btn-primary" style="display:none;">‚ûï Ajouter Agent</button>
                <div style="flex: 1;"></div>
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Rechercher (nom, matricule...)">
            </div>

            <div id="info" class="info" style="display:none;"></div>
        </header>

        <div class="stats" id="stats" style="display:none;">
            <div class="stat-card">
                <h3>Total Agents</h3>
                <p id="totalAgents">0</p>
            </div>
            <div class="stat-card">
                <h3>Visites √† venir</h3>
                <p id="visitesCount">0</p>
            </div>
            <div class="stat-card">
                <h3>R.482 A</h3>
                <p id="r482aCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Permis</h3>
                <p id="permisCount">0</p>
            </div>
        </div>

        <div id="agentsContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üìÇ</div>
                <h3>Aucun fichier charg√©</h3>
                <p>Cliquez sur "Charger le fichier Excel" pour commencer</p>
            </div>
        </div>
    </div>

    <!-- Modal d'√©dition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Modifier l'agent</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div id="editForm"></div>
            <div class="modal-actions">
                <button class="btn-success" onclick="saveAgentEdit()">üíæ Enregistrer</button>
                <button class="btn-danger" onclick="closeEditModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let currentData = [];
        let headers = [];
        let allAgents = [];
        let editingAgentIndex = null;

        const fileInput = document.getElementById('fileInput');
        const btnSave = document.getElementById('btnSave');
        const btnAddAgent = document.getElementById('btnAddAgent');
        const info = document.getElementById('info');
        const searchBox = document.getElementById('searchBox');
        const stats = document.getElementById('stats');
        const agentsContainer = document.getElementById('agentsContainer');
        const editModal = document.getElementById('editModal');

        fileInput.addEventListener('change', handleFile);
        btnSave.addEventListener('click', saveFile);
        searchBox.addEventListener('input', filterAgents);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array', cellDates: true });

                    if (!workbook.SheetNames.includes('config')) {
                        alert('‚ùå Feuille "config" introuvable');
                        return;
                    }

                    const sheet = workbook.Sheets['config'];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    if (jsonData.length < 2) {
                        alert('‚ùå Pas de donn√©es dans la feuille config');
                        return;
                    }

                    headers = jsonData[0];
                    currentData = jsonData.slice(1).filter(row => row.some(cell => cell !== ''));

                    // Parser les agents
                    parseAgents();
                    displayAgents();
                    updateStats();

                    info.style.display = 'block';
                    info.textContent = `‚úÖ ${file.name} charg√© - ${allAgents.length} agents`;
                    btnSave.style.display = 'inline-block';
                    btnAddAgent.style.display = 'inline-block';
                    stats.style.display = 'grid';

                } catch (err) {
                    alert('‚ùå Erreur: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseAgents() {
            const matriculeIdx = headers.findIndex(h => h && typeof h === 'string' && h.toLowerCase().includes('matricule'));
            const nomIdx = headers.findIndex(h => h && typeof h === 'string' && h.toLowerCase().includes('nom'));
            const prenomIdx = headers.findIndex(h => h && typeof h === 'string' && h.toLowerCase().includes('pr√©nom'));
            const r482aIdx = headers.findIndex(h => h && typeof h === 'string' && h.includes('R.482 A'));
            const r482b1Idx = headers.findIndex(h => h && typeof h === 'string' && h.includes('R.482 B1'));
            const permisIdx = headers.findIndex(h => h && typeof h === 'string' && h.toLowerCase().includes('permis'));
            const visiteMedIdx = headers.findIndex(h => h && typeof h === 'string' && h.toLowerCase().includes('prochaines visites'));

            // Groupes d√©finis
            const groupes = {
                'Encadrant': ['DEBREYNE', 'LUTARD', 'HAUTDECOEUR', 'FOURCADE', 'GONCALVES', 'SIGALA', 'BETTINGER', 'TUCOULET', 'VRBOVSKA', 'GRENET'],
                'Surveillant de travaux': ['BOURGOIN', 'MERCADIEU', 'GARCIA', 'LARROUDE', 'SAMITIER', 'PIEL'],
                'Encadrant Propret√©': ['GOURVIAT', 'LARTIGUE', 'TRIQUENEAUX', 'ESPERON', 'ROUGLAN', 'NOURRI'],
                'Agents Voirie': ['BERRIO-GAUDNER', 'FONTENEAU', 'GUIJARRO', 'GOUREAU', 'LABORIE', 'LARRIEU', 'LEVIGNAT', 'MARTIN-HERNANDEZ', 'PIERRE', 'SOLA', 'WEISS'],
                'Agent EV': ['DELANDE', 'DA SILVA REIS', 'ELMAGROUD', 'ESTEVE', 'KADRI', 'MALLET', 'MAURY', 'MOINGT', 'REY', 'TADJROUNA', 'VILLENEUVE'],
                'COMMUN - Magasinier': ['VOL', 'GENNA', 'BERNARD', 'HAUBRAICHE']
            };

            allAgents = currentData.map((row, idx) => {
                const nom = (row[nomIdx] || '').trim().toUpperCase();
                const prenom = row[prenomIdx] || '';
                const matricule = row[matriculeIdx] || '';

                // D√©terminer le groupe - MATCH EXACT UNIQUEMENT
                let groupe = 'default';

                for (const [groupeName, noms] of Object.entries(groupes)) {
                    if (noms.some(n => nom === n)) {  // Match exact seulement
                        groupe = groupeName;
                        break;
                    }
                }

                return {
                    index: idx,
                    matricule: matricule,
                    nom: row[nomIdx] || '',
                    prenom: prenom,
                    fullName: `${prenom} ${row[nomIdx] || ''}`.trim(),
                    r482a: row[r482aIdx] || '',
                    r482b1: row[r482b1Idx] || '',
                    permis: row[permisIdx] || '',
                    visiteMed: row[visiteMedIdx] || '',
                    groupe: groupe,
                    row: row
                };
            }).filter(a => a.nom && a.nom.trim() !== '');  // Filtrer uniquement les lignes avec un nom valide
        } function displayAgents() {
            if (allAgents.length === 0) {
                agentsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <h3>Aucun agent trouv√©</h3>
                    </div>`;
                return;
            }

            agentsContainer.innerHTML = `<div class="agents-grid"></div>`;
            const grid = agentsContainer.querySelector('.agents-grid');

            allAgents.forEach(agent => {
                const card = createAgentCard(agent);
                grid.appendChild(card);
            });
        }

        function createAgentCard(agent) {
            const card = document.createElement('div');
            card.className = 'agent-card';

            // Couleurs selon le groupe
            const groupeColors = {
                'Encadrant': { border: '#ff9800', gradient: 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' },
                'Surveillant de travaux': { border: '#9c27b0', gradient: 'linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%)' },
                'Encadrant Propret√©': { border: '#00bcd4', gradient: 'linear-gradient(135deg, #00bcd4 0%, #0097a7 100%)' },
                'Agents Voirie': { border: '#2196f3', gradient: 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)' },
                'Agent EV': { border: '#4caf50', gradient: 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)' },
                'COMMUN - Magasinier': { border: '#795548', gradient: 'linear-gradient(135deg, #795548 0%, #5d4037 100%)' },
                'default': { border: '#9e9e9e', gradient: 'linear-gradient(135deg, #9e9e9e 0%, #757575 100%)' }
            };

            const colors = groupeColors[agent.groupe] || groupeColors.default;
            card.style.borderLeftColor = colors.border;

            const initials = `${agent.prenom[0] || ''}${agent.nom[0] || ''}`.toUpperCase();

            const badges = [];
            if (agent.r482a) badges.push({ text: 'R.482 A', type: 'success' });
            if (agent.r482b1) badges.push({ text: 'R.482 B1', type: 'success' });
            if (agent.permis) badges.push({ text: agent.permis, type: '' });

            // Badge de groupe
            const groupeBadge = agent.groupe !== 'default' ?
                `<span class="badge" style="background: ${colors.border}20; color: ${colors.border}; border: 1px solid ${colors.border}">${agent.groupe}</span>` : '';

            card.innerHTML = `
                <div class="agent-header">
                    <div class="agent-avatar" style="background: ${colors.gradient}">${initials}</div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.fullName}</div>
                        <div class="agent-matricule">${agent.matricule}</div>
                    </div>
                </div>
                
                <div class="agent-details">
                    ${agent.visiteMed ? `
                    <div class="detail-row">
                        <span class="detail-label">üè• Prochaine visite</span>
                        <span class="detail-value">${agent.visiteMed}</span>
                    </div>` : ''}
                </div>

                <div class="badges">
                    ${groupeBadge}
                    ${badges.map(b => `<span class="badge ${b.type}">${b.text}</span>`).join('')}
                    ${badges.length === 0 && !groupeBadge ? '<span class="badge">Aucune certification</span>' : ''}
                </div>

                <div class="agent-actions">
                    <button class="action-btn edit" onclick="editAgent(${agent.index})">‚úèÔ∏è Modifier</button>
                    <button class="action-btn delete" onclick="deleteAgent(${agent.index})">üóëÔ∏è Supprimer</button>
                </div>
            `;

            return card;
        }

        function updateStats() {
            document.getElementById('totalAgents').textContent = allAgents.length;
            document.getElementById('r482aCount').textContent = allAgents.filter(a => a.r482a).length;
            document.getElementById('permisCount').textContent = allAgents.filter(a => a.permis).length;
            document.getElementById('visitesCount').textContent = allAgents.filter(a => a.visiteMed).length;
        }

        function filterAgents() {
            const term = searchBox.value.toLowerCase();
            const filteredAgents = allAgents.filter(a => a.nom && a.nom.trim() !== '');
            filteredAgents.forEach((agent, idx) => {
                const card = document.querySelectorAll('.agent-card')[idx];
                if (!card) return;
                const match = agent.fullName.toLowerCase().includes(term) ||
                    agent.matricule.toLowerCase().includes(term);
                card.style.display = match ? '' : 'none';
            });
        }

        function editAgent(index) {
            editingAgentIndex = index;
            const agent = allAgents.find(a => a.index === index);

            if (!agent) {
                alert('‚ùå Agent introuvable');
                return;
            }

            // Cr√©er le formulaire avec toutes les colonnes
            let formHTML = `
                <div class="form-group">
                    <label>üè∑Ô∏è Groupe</label>
                    <select id="field_groupe">
                        <option value="default" ${agent.groupe === 'default' ? 'selected' : ''}>-- Non d√©fini --</option>
                        <option value="Encadrant" ${agent.groupe === 'Encadrant' ? 'selected' : ''}>Encadrant</option>
                        <option value="Surveillant de travaux" ${agent.groupe === 'Surveillant de travaux' ? 'selected' : ''}>Surveillant de travaux</option>
                        <option value="Encadrant Propret√©" ${agent.groupe === 'Encadrant Propret√©' ? 'selected' : ''}>Encadrant Propret√©</option>
                        <option value="Agents Voirie" ${agent.groupe === 'Agents Voirie' ? 'selected' : ''}>Agents Voirie</option>
                        <option value="Agent EV" ${agent.groupe === 'Agent EV' ? 'selected' : ''}>Agent EV</option>
                        <option value="COMMUN - Magasinier" ${agent.groupe === 'COMMUN - Magasinier' ? 'selected' : ''}>COMMUN - Magasinier</option>
                    </select>
                </div>
            `;

            headers.forEach((header, colIdx) => {
                if (!header || typeof header !== 'string') return;
                const value = currentData[agent.index][colIdx] || '';
                const fieldType = (header.toLowerCase().includes('date')) ? 'date' : 'text';
                let displayValue = value;

                if (fieldType === 'date' && value instanceof Date) {
                    displayValue = value.toISOString().split('T')[0];
                }

                formHTML += `
                    <div class="form-group">
                        <label>${header}</label>
                        <input type="${fieldType}" 
                               id="field_${colIdx}" 
                               value="${displayValue}" 
                               data-col="${colIdx}">
                    </div>
                `;
            });

            document.getElementById('editForm').innerHTML = formHTML;
            editModal.classList.add('active');
        }

        function closeEditModal() {
            editModal.classList.remove('active');
            editingAgentIndex = null;
        }

        function saveAgentEdit() {
            if (editingAgentIndex === null) return;

            const agent = allAgents.find(a => a.index === editingAgentIndex);
            if (!agent) return;

            // Sauvegarder le groupe s√©lectionn√©
            const groupeSelect = document.getElementById('field_groupe');
            if (groupeSelect) {
                agent.groupe = groupeSelect.value;
            }

            // R√©cup√©rer toutes les valeurs modifi√©es
            headers.forEach((header, colIdx) => {
                const input = document.getElementById(`field_${colIdx}`);
                if (input) {
                    currentData[agent.index][colIdx] = input.value;
                }
            });

            // Rafra√Æchir l'affichage
            parseAgents();
            displayAgents();
            updateStats();
            closeEditModal();
        }

        function deleteAgent(index) {
            const agent = allAgents.find(a => a.index === index);
            if (!agent) {
                alert('‚ùå Agent introuvable');
                return;
            }
            if (!confirm(`Supprimer ${agent.fullName} ?`)) return;
            currentData.splice(agent.index, 1);
            parseAgents();
            displayAgents();
            updateStats();
        }

        function saveFile() {
            if (!workbook) return;

            const newSheetData = [headers, ...currentData];
            const newSheet = XLSX.utils.aoa_to_sheet(newSheetData);
            workbook.Sheets['config'] = newSheet;

            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `2026_PRESENCES_${Date.now()}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Fichier t√©l√©charg√© !');
        }
    </script>
</body>

</html>